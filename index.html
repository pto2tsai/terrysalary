<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>薪資管理系統 (V12 - 完整欄位版)</title>
    
    <!-- 1. 引入樣式與核心庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        /* 基礎樣式與列印設定 */
        body { background-color: #f3f4f6; color: #1f2937; font-family: system-ui, -apple-system, sans-serif; }
        @media print {
            @page { size: A4; margin: 5mm; }
            body { background-color: white; -webkit-print-color-adjust: exact; }
            .print-hidden { display: none !important; }
            .print-block { display: block !important; }
            .print-grid-2 { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 0.5rem !important; }
            .break-inside-avoid { break-inside: avoid; page-break-inside: avoid; }
            .print-text-xs { font-size: 10px !important; line-height: 1.2 !important; }
            .print-text-tiny { font-size: 9px !important; line-height: 1.1 !important; }
            .print-text-base { font-size: 14px !important; }
            ::-webkit-scrollbar { display: none; }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .dashed-border { background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%233B82F6FF' stroke-width='4' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); }
    </style>

    <!-- 2. 全域錯誤攔截 -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('loading-screen').style.display = 'none';
            const errorBox = document.getElementById('error-display');
            errorBox.style.display = 'block';
            errorBox.innerHTML = `
                <h2 style="font-weight:bold; font-size:1.2em; margin-bottom:10px;">⚠️ 系統發生錯誤</h2>
                <p><strong>錯誤訊息：</strong> ${msg}</p>
                <button onclick="resetApp()" style="margin-top:15px; padding:8px 16px; background:#dc2626; color:white; border:none; border-radius:4px; cursor:pointer;">清除資料並修復</button>
            `;
            return false;
        };
        function resetApp() {
            localStorage.removeItem('payroll_employees');
            localStorage.removeItem('payroll_data');
            alert('已清除暫存資料，系統將重新整理。');
            window.location.reload();
        }
    </script>
</head>
<body>

    <div id="loading-screen">
        <div style="width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 15px; color: #6b7280;">系統載入中...</p>
        <button onclick="resetApp()" style="margin-top: 20px; font-size: 12px; color: #ef4444; text-decoration: underline; background: none; border: none; cursor: pointer;">若卡住太久，請點此重置</button>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <div id="error-display"></div>
    <div id="root"></div>

    <script type="text/babel">
        setTimeout(() => { const loader = document.getElementById('loading-screen'); if(loader) loader.style.display = 'none'; }, 800);

        const { useState, useMemo, useEffect, useRef } = React;

        // --- 圖示組件 ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const Icons = {
            Calculator: (props) => <Icon {...props} path={<><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></>} />,
            Users: (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            Printer: (props) => <Icon {...props} path={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></>} />,
            Plus: (props) => <Icon {...props} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
            Trash2: (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Settings: (props) => <Icon {...props} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            Upload: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />,
            Clock: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
            HelpCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></>} />,
            FileSpreadsheet: (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></>} />,
            RefreshCw: (props) => <Icon {...props} path={<><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></>} />,
            Edit: (props) => <Icon {...props} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>} />
        };

        const INITIAL_EMPLOYEES = [
            { id: 1, name: '範例-張耀升', empId: 'W0001', baseSalary: 28590, laborFee: 1100, healthFee: 750, title: '作業員' },
            { id: 2, name: '範例-李小美', empId: 'W0002', baseSalary: 42000, laborFee: 1200, healthFee: 800, title: '行政主管' },
        ];

        // 資料結構 V12: 確認 businessBonus 與 annualLeave 欄位
        const INITIAL_PAYROLL_DATA = [
            { 
                empId: 1, period: '2025-11', 
                wt034: "10:00", wt067: "00:00", 
                hd134: "00:00", hd167: "00:00",  
                earlyShift: "00:00", noLunch: "00:00", holidayOT: "00:00", 
                sickLeave: "00:00", personalLeave: "00:00", annualLeave: "00:00", bereavementLeave: "00:00",
                lunchAllowance: 0, businessBonus: 0, 
                deduction: 0, 
                expectedWorkDays: 20, actualWorkHours: "160:00",
                note: '' 
            },
        ];

        const PayrollApp = () => {
            const [activeTab, setActiveTab] = useState('employees');
            const [employees, setEmployees] = useState(() => {
                try { return JSON.parse(localStorage.getItem('payroll_employees')) || INITIAL_EMPLOYEES; } catch(e) { return INITIAL_EMPLOYEES; }
            });
            const [payrollData, setPayrollData] = useState(() => {
                try { return JSON.parse(localStorage.getItem('payroll_data')) || INITIAL_PAYROLL_DATA; } catch(e) { return INITIAL_PAYROLL_DATA; }
            });
            
            const [currentPeriod, setCurrentPeriod] = useState(new Date().toISOString().slice(0, 7));
            const [editingEmp, setEditingEmp] = useState(null);
            const [isEmpModalOpen, setIsEmpModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [isBulkModalOpen, setIsBulkModalOpen] = useState(false);
            
            const [bulkTargetSalary, setBulkTargetSalary] = useState(29500);
            const [bulkFilterType, setBulkFilterType] = useState('salary');
            const [bulkFilterValue, setBulkFilterValue] = useState(28590);

            const fileInputRef = useRef(null);

            useEffect(() => { localStorage.setItem('payroll_employees', JSON.stringify(employees)); }, [employees]);
            useEffect(() => { localStorage.setItem('payroll_data', JSON.stringify(payrollData)); }, [payrollData]);

            // --- 輔助函式 ---
            const timeStrToHours = (str) => {
                if (!str) return 0;
                if (typeof str === 'number') return str; 
                const [h, m] = str.toString().split(':').map(Number);
                return h + (m || 0) / 60;
            };

            const hoursToTimeStr = (hours) => {
                if (!hours && hours !== 0) return "00:00";
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            };

            // --- V12 核心薪資計算 ---
            const calculateSalary = (emp, data) => {
                if (!emp) return null;
                const d = data || {};
                
                const hourlyRate = Math.round(emp.baseSalary / 240);
                
                // 加項
                const payWt034 = Math.round(timeStrToHours(d.wt034) * 0.34 * hourlyRate);
                const payWt067 = Math.round(timeStrToHours(d.wt067) * 0.67 * hourlyRate);
                const payHd134 = Math.round(timeStrToHours(d.hd134) * 1.34 * hourlyRate);
                const payHd167 = Math.round(timeStrToHours(d.hd167) * 1.67 * hourlyRate);
                const payEarly = Math.round(timeStrToHours(d.earlyShift) * 0.34 * hourlyRate);
                const payNoLunch = Math.round(timeStrToHours(d.noLunch) * 0.34 * hourlyRate);
                const payHolidayOT = Math.round(timeStrToHours(d.holidayOT) * 1.34 * hourlyRate);
                const payAnnual = Math.round(timeStrToHours(d.annualLeave) * 1.0 * hourlyRate); 

                // 業務加給 & 午餐津貼
                const allowances = (parseInt(d.lunchAllowance) || 0) + (parseInt(d.businessBonus) || 0);

                const totalAdditions = payWt034 + payWt067 + payHd134 + payHd167 + payEarly + payNoLunch + payHolidayOT + payAnnual + allowances;
                const grossPay = emp.baseSalary + totalAdditions;

                // 扣項
                const dedSick = Math.round(timeStrToHours(d.sickLeave) * 0.5 * hourlyRate);
                const dedPersonal = Math.round(timeStrToHours(d.personalLeave) * 1.0 * hourlyRate);
                
                // 缺勤扣款
                const expectedHours = (d.expectedWorkDays || 0) * 8;
                const actualHours = timeStrToHours(d.actualWorkHours);
                let absenceHours = 0;
                let dedAbsence = 0;

                if (expectedHours > 0 && actualHours < expectedHours) {
                    absenceHours = expectedHours - actualHours;
                    dedAbsence = Math.round(absenceHours * hourlyRate);
                }

                let insuranceFee = 0;
                let finalDeduction = 0;

                if (d.hasImportedInsurance) {
                    insuranceFee = parseInt(d.deduction) || 0;
                    finalDeduction = dedSick + dedPersonal + dedAbsence + insuranceFee; 
                } else {
                    insuranceFee = emp.laborFee + emp.healthFee;
                    finalDeduction = dedSick + dedPersonal + dedAbsence + insuranceFee + (parseInt(d.deduction) || 0);
                }

                const netPay = grossPay - finalDeduction;

                return { 
                    hourlyRate, 
                    payWt034, payWt067, payHd134, payHd167, payEarly, payNoLunch, payHolidayOT, payAnnual,
                    dedSick, dedPersonal, dedAbsence, absenceHours: hoursToTimeStr(absenceHours), expectedHours,
                    totalAdditions, finalDeduction, netPay, insuranceFee, grossPay
                };
            };

            const fullPayrollList = useMemo(() => {
                return employees.map(emp => {
                    let data = payrollData.find(d => d.empId === emp.id && d.period === currentPeriod);
                    if (!data) data = { empId: emp.id, period: currentPeriod };
                    
                    const safeData = {
                        wt034: data.wt034 || "00:00", wt067: data.wt067 || "00:00",
                        hd134: data.hd134 || "00:00", hd167: data.hd167 || "00:00",
                        earlyShift: data.earlyShift || "00:00", noLunch: data.noLunch || "00:00", holidayOT: data.holidayOT || "00:00",
                        sickLeave: data.sickLeave || "00:00", personalLeave: data.personalLeave || "00:00", 
                        annualLeave: data.annualLeave || "00:00", bereavementLeave: data.bereavementLeave || "00:00",
                        lunchAllowance: data.lunchAllowance || 0, businessBonus: data.businessBonus || 0,
                        deduction: data.deduction || 0, note: data.note || '', 
                        hasImportedInsurance: data.hasImportedInsurance,
                        expectedWorkDays: data.expectedWorkDays || 0,
                        actualWorkHours: data.actualWorkHours || "00:00"
                    };
                    return { ...emp, ...safeData, ...calculateSalary(emp, safeData) };
                });
            }, [employees, payrollData, currentPeriod]);

            const hasDataForCurrentMonth = useMemo(() => fullPayrollList.some(i => i.grossPay > i.baseSalary || i.note), [fullPayrollList]);

            const updateVal = (empId, field, value) => {
                setPayrollData(prev => {
                    const idx = prev.findIndex(p => p.empId === empId && p.period === currentPeriod);
                    const isTimeField = ['wt034','wt067','hd134','hd167','earlyShift','noLunch','holidayOT','sickLeave','personalLeave','annualLeave','actualWorkHours'].includes(field);
                    const val = (field === 'note' || field === 'period' || isTimeField) ? value : Number(value);
                    
                    let newData = [...prev];
                    if (idx >= 0) {
                        newData[idx] = { ...newData[idx], [field]: val };
                        if (field === 'deduction') newData[idx].hasImportedInsurance = false; 
                    } else {
                        newData.push({ empId, period: currentPeriod, [field]: val });
                    }
                    return newData;
                });
            };

            // Excel Parsing V12
            const excelTimeToString = (val) => {
                if (typeof val === 'string') return val; 
                if (typeof val === 'number') {
                    const totalHours = val * 24;
                    const h = Math.floor(totalHours);
                    const m = Math.round((totalHours - h) * 60);
                    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                }
                return "00:00";
            };

            const parseLeave = (note) => {
                let sick=0, personal=0, annual=0, bereavement=0;
                if (!note) return { sick: "00:00", personal: "00:00", annual: "00:00", bereavement: "00:00" };
                const str = note.toString();
                
                const parseMatch = (regex) => {
                    const match = str.match(regex);
                    if (match) {
                        const h = parseInt(match[2]) || 0;
                        const m = parseInt(match[4]) || 0;
                        return h + m/60;
                    }
                    return 0;
                };

                sick = parseMatch(/(病假)\s*(\d+)([:\.](\d+))?/);
                personal = parseMatch(/(事假|曠職|扣薪|颱風)\s*(\d+)([:\.](\d+))?/);
                annual = parseMatch(/(特休|年假)\s*(\d+)([:\.](\d+))?/);
                bereavement = parseMatch(/(喪假)\s*(\d+)([:\.](\d+))?/);

                return { 
                    sick: hoursToTimeStr(sick), 
                    personal: hoursToTimeStr(personal), 
                    annual: hoursToTimeStr(annual), 
                    bereavement: hoursToTimeStr(bereavement) 
                };
            };

            const handleExcel = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: "" });
                        
                        let hRow = -1;
                        for(let i=0; i<Math.min(data.length, 20); i++) {
                            if(JSON.stringify(data[i]).includes("員工編號")) { hRow = i; break; }
                        }
                        if(hRow === -1) throw new Error("找不到標題列");

                        const headers = data[hRow];
                        const rows = data.slice(hRow+1);
                        
                        const idx = { id:-1, name:-1, wt034:[], wt067:[], hd134:[], hd167:[], early:-1, noLunch:-1, holidayOT:-1, lunch:-1, bonus:-1, ins:-1, note:-1, expDays:-1, actHours:-1, annual:-1 };
                        let satIdx = headers.findIndex(h => String(h).includes("星期六") || String(h).includes("假日"));
                        
                        headers.forEach((h, i) => {
                            const t = String(h).trim();
                            if(t.includes("員工編號")) idx.id = i;
                            else if(t.includes("員工姓名")) idx.name = i;
                            else if(t.includes("1.33") || t.includes("1.34")) {
                                if(satIdx > -1 && i > satIdx) idx.hd134.push(i); else idx.wt034.push(i);
                            }
                            else if(t.includes("1.66") || t.includes("1.67")) {
                                if(satIdx > -1 && i > satIdx) idx.hd167.push(i); else idx.wt067.push(i);
                            }
                            else if(t.includes("提前")) idx.early = i;
                            else if(t.includes("中午")) idx.noLunch = i;
                            else if(t.includes("星期日")) idx.holidayOT = i;
                            else if(t.includes("午餐") || t.includes("補助")) idx.lunch = i;
                            else if(t.includes("業務") || t.includes("職務") || t.includes("加給")) idx.bonus = i;
                            else if(t.includes("勞健保")) idx.ins = i;
                            else if(t.includes("備註")) idx.note = i;
                            else if(t.includes("應上班") || t.includes("應出勤")) {
                                if(t.includes("次數") || t.includes("天數")) idx.expDays = i;
                            }
                            else if(t.includes("實上班") || t.includes("實際出勤")) {
                                if(t.includes("時數")) idx.actHours = i;
                            }
                            else if(t.includes("特休") && !t.includes("備註")) idx.annual = i; // 獨立特休欄位偵測
                        });
                        if(idx.note === -1) idx.note = headers.length -1;

                        let count = 0;
                        const newPayroll = [...payrollData];
                        const newEmps = [...employees];

                        // 輔助：加總多個欄位的時間字串
                        const sumTimeStrs = (row, indices) => {
                            let totalH = 0;
                            indices.forEach(i => {
                                const val = row[i];
                                if(typeof val === 'number') totalH += val * 24; 
                                else if(typeof val === 'string' && val.includes(':')) {
                                    const [h,m] = val.split(':').map(Number);
                                    totalH += h + m/60;
                                }
                            });
                            return hoursToTimeStr(totalH);
                        };

                        rows.forEach(row => {
                            const eid = String(row[idx.id]||"").trim();
                            const ename = String(row[idx.name]||"").trim();
                            if(!eid) return;

                            let emp = newEmps.find(e => e.empId === eid);
                            if(!emp && ename) {
                                emp = { id: Date.now()+Math.random(), empId: eid, name: ename, baseSalary: 28590, laborFee:0, healthFee:0, title:"員工" };
                                newEmps.push(emp);
                            }

                            if(emp) {
                                const noteText = String(row[idx.note]||"");
                                const leaves = parseLeave(noteText);

                                // 工時
                                let expDays = parseInt(row[idx.expDays]) || 0;
                                
                                // 特休：優先使用獨立欄位，沒有則用備註解析
                                let annualH = "00:00";
                                if (idx.annual !== -1 && row[idx.annual]) {
                                    annualH = excelTimeToString(row[idx.annual]);
                                } else {
                                    annualH = leaves.annual;
                                }

                                const entry = {
                                    empId: emp.id, period: currentPeriod,
                                    wt034: sumTimeStrs(row, idx.wt034),
                                    wt067: sumTimeStrs(row, idx.wt067),
                                    hd134: sumTimeStrs(row, idx.hd134),
                                    hd167: sumTimeStrs(row, idx.hd167),
                                    earlyShift: excelTimeToString(row[idx.early]),
                                    noLunch: excelTimeToString(row[idx.noLunch]),
                                    holidayOT: excelTimeToString(row[idx.holidayOT]),
                                    lunchAllowance: parseInt(row[idx.lunch])||0,
                                    businessBonus: parseInt(row[idx.bonus])||0,
                                    deduction: parseInt(row[idx.ins])||0,
                                    hasImportedInsurance: !!(parseInt(row[idx.ins])),
                                    expectedWorkDays: expDays,
                                    actualWorkHours: excelTimeToString(row[idx.actHours]),
                                    sickLeave: leaves.sick,
                                    personalLeave: leaves.personal,
                                    annualLeave: annualH,
                                    bereavementLeave: leaves.bereavement,
                                    note: noteText
                                };

                                const existIdx = newPayroll.findIndex(p => p.empId === emp.id && p.period === currentPeriod);
                                if(existIdx >= 0) newPayroll[existIdx] = { ...newPayroll[existIdx], ...entry };
                                else newPayroll.push(entry);
                                count++;
                            }
                        });
                        setEmployees(newEmps);
                        setPayrollData(newPayroll);
                        setIsImportModalOpen(false);
                        alert(`成功匯入 ${count} 筆資料！\n業務加給與特休時數已更新。`);

                    } catch(err) { console.error(err); alert("匯入失敗: " + err.message); }
                    if(fileInputRef.current) fileInputRef.current.value = '';
                };
                reader.readAsBinaryString(file);
            };

            // ... Employee CRUD & Bulk Logic ...
            const handleSaveEmployee = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const newEmp = {
                    id: editingEmp ? editingEmp.id : Date.now(),
                    name: fd.get('name'), empId: fd.get('empId'), title: fd.get('title'),
                    baseSalary: Number(fd.get('baseSalary')), laborFee: Number(fd.get('laborFee')), healthFee: Number(fd.get('healthFee'))
                };
                setEmployees(prev => editingEmp ? prev.map(e => e.id === editingEmp.id ? newEmp : e) : [...prev, newEmp]);
                setIsEmpModalOpen(false);
            };
            const deleteEmployee = (id) => { if(confirm('刪除?')) setEmployees(prev => prev.filter(e => e.id !== id)); };
            const clearAllData = () => { if(confirm('清空?')) { setEmployees([]); setPayrollData([]); } };
            const handleBulkSubmit = (e) => {
                e.preventDefault();
                const target = Number(bulkTargetSalary);
                if(!target) return;
                let c = 0;
                setEmployees(prev => prev.map(emp => {
                    let ok = false;
                    if(bulkFilterType==='all') ok=true;
                    else if(bulkFilterType==='title' && emp.title.includes(String(bulkFilterValue))) ok=true;
                    else if(bulkFilterType==='salary' && emp.baseSalary===Number(bulkFilterValue)) ok=true;
                    if(ok) { c++; return {...emp, baseSalary: target}; }
                    return emp;
                }));
                setIsBulkModalOpen(false);
                alert(`更新 ${c} 人`);
            };

            return (
                <div className="min-h-screen pb-10">
                    <nav className="bg-slate-800 text-white shadow-lg print-hidden sticky top-0 z-40">
                        <div className="max-w-7xl mx-auto px-4 flex justify-between h-16 items-center">
                            <div className="flex items-center space-x-2"><Icons.Calculator className="w-6 h-6 text-yellow-400"/><span className="font-bold text-xl">薪資管理系統 V12</span></div>
                            <div className="flex space-x-2">
                                <button onClick={()=>setActiveTab('employees')} className={`px-3 py-1 rounded ${activeTab==='employees'?'bg-yellow-500 text-black':'hover:bg-slate-700'}`}>設定</button>
                                <button onClick={()=>setActiveTab('input')} className={`px-3 py-1 rounded ${activeTab==='input'?'bg-yellow-500 text-black':'hover:bg-slate-700'}`}>結算</button>
                                <button onClick={()=>setActiveTab('print')} className={`px-3 py-1 rounded ${activeTab==='print'?'bg-yellow-500 text-black':'hover:bg-slate-700'}`}>列印</button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto p-4 md:p-8 print-block print:p-0 print:max-w-none">
                        
                        {activeTab === 'employees' && (
                            <div className="bg-white rounded-xl shadow p-6 animate-fade-in">
                                <div className="flex justify-between mb-4">
                                    <h2 className="text-xl font-bold flex items-center"><Icons.Users className="w-5 h-5 mr-2 text-blue-600"/> 員工資料</h2>
                                    <div className="space-x-2">
                                        <button onClick={()=>setIsBulkModalOpen(true)} className="px-3 py-1 bg-orange-100 text-orange-700 rounded border border-orange-200">批量調薪</button>
                                        <button onClick={()=>setEditingEmp({}) || setIsEmpModalOpen(true)} className="px-3 py-1 bg-blue-600 text-white rounded">新增</button>
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full text-sm">
                                        <thead className="bg-slate-50 text-left"><tr><th className="p-2">編號</th><th className="p-2">姓名</th><th className="p-2">底薪</th><th className="p-2">勞健保</th><th className="p-2">操作</th></tr></thead>
                                        <tbody>{employees.map(e => (
                                            <tr key={e.id} className="border-b hover:bg-slate-50"><td className="p-2">{e.empId}</td><td className="p-2">{e.name} ({e.title})</td><td className="p-2">${e.baseSalary}</td><td className="p-2 text-red-600">-{e.laborFee+e.healthFee}</td><td className="p-2"><button onClick={()=>{setEditingEmp(e);setIsEmpModalOpen(true)}} className="text-blue-600 mr-2">編輯</button><button onClick={()=>deleteEmployee(e.id)} className="text-red-600">刪除</button></td></tr>
                                        ))}</tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'input' && (
                            <div className="bg-white rounded-xl shadow p-6 animate-fade-in overflow-x-auto">
                                <div className="flex justify-between mb-4">
                                    <h2 className="text-xl font-bold flex items-center"><Icons.Clock className="w-5 h-5 mr-2 text-green-600"/> 薪資結算</h2>
                                    <div className="flex space-x-2">
                                        <input type="month" value={currentPeriod} onChange={e=>setCurrentPeriod(e.target.value)} className="border rounded px-2"/>
                                        <button onClick={()=>setIsImportModalOpen(true)} className="px-3 py-1 bg-emerald-600 text-white rounded">匯入 Excel</button>
                                    </div>
                                </div>
                                {!hasDataForCurrentMonth && employees.length > 0 && <div onClick={()=>setIsImportModalOpen(true)} className="p-8 dashed-border text-center bg-blue-50 text-blue-600 cursor-pointer mb-4">點此匯入本月總表</div>}
                                <table className="min-w-full text-xs whitespace-nowrap">
                                    <thead className="bg-slate-100">
                                        <tr>
                                            <th className="p-2 text-left sticky left-0 bg-slate-100">員工</th>
                                            <th className="p-2 text-slate-600">實工</th>
                                            <th className="p-2 bg-blue-50 text-blue-700">平加<br/>0.34</th>
                                            <th className="p-2 bg-blue-50 text-blue-700">平加<br/>0.67</th>
                                            <th className="p-2 bg-purple-50 text-purple-700">例加<br/>1.34</th>
                                            <th className="p-2 bg-purple-50 text-purple-700">例加<br/>1.67</th>
                                            <th className="p-2">提早<br/>0.34</th>
                                            <th className="p-2">未休<br/>0.34</th>
                                            <th className="p-2">休加<br/>1.34</th>
                                            <th className="p-2 text-emerald-700 bg-emerald-50">特休<br/>補薪</th>
                                            <th className="p-2 text-green-700">午餐<br/>津貼</th>
                                            <th className="p-2 text-green-700 bg-green-50">業務<br/>加給</th>
                                            <th className="p-2 text-red-700">病假<br/>0.5</th>
                                            <th className="p-2 text-red-800">事/颱<br/>1.0</th>
                                            <th className="p-2 text-orange-700">勞健<br/>扣款</th>
                                            <th className="p-2 sticky right-0 bg-slate-100">實發</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {fullPayrollList.map(item => (
                                            <tr key={item.id} className="border-b hover:bg-gray-50">
                                                <td className="p-2 sticky left-0 bg-white font-bold">{item.name}</td>
                                                <td className="p-1"><input type="text" className="w-12 border bg-gray-100" value={item.actualWorkHours} onChange={e=>updateVal(item.id,'actualWorkHours',e.target.value)}/></td>
                                                <td className="p-1 bg-blue-50"><input type="text" className="w-10 border" value={item.wt034} onChange={e=>updateVal(item.id,'wt034',e.target.value)}/></td>
                                                <td className="p-1 bg-blue-50"><input type="text" className="w-10 border" value={item.wt067} onChange={e=>updateVal(item.id,'wt067',e.target.value)}/></td>
                                                <td className="p-1 bg-purple-50"><input type="text" className="w-10 border" value={item.hd134} onChange={e=>updateVal(item.id,'hd134',e.target.value)}/></td>
                                                <td className="p-1 bg-purple-50"><input type="text" className="w-10 border" value={item.hd167} onChange={e=>updateVal(item.id,'hd167',e.target.value)}/></td>
                                                <td className="p-1"><input type="text" className="w-10 border" value={item.earlyShift} onChange={e=>updateVal(item.id,'earlyShift',e.target.value)}/></td>
                                                <td className="p-1"><input type="text" className="w-10 border" value={item.noLunch} onChange={e=>updateVal(item.id,'noLunch',e.target.value)}/></td>
                                                <td className="p-1"><input type="text" className="w-10 border" value={item.holidayOT} onChange={e=>updateVal(item.id,'holidayOT',e.target.value)}/></td>
                                                <td className="p-1 bg-emerald-50"><input type="text" className="w-12 border font-bold text-emerald-700" value={item.annualLeave} onChange={e=>updateVal(item.id,'annualLeave',e.target.value)}/></td>
                                                <td className="p-1"><input type="number" className="w-12 border" value={item.lunchAllowance} onChange={e=>updateVal(item.id,'lunchAllowance',e.target.value)}/></td>
                                                <td className="p-1 bg-green-50"><input type="number" className="w-14 border font-bold text-green-700" value={item.businessBonus} onChange={e=>updateVal(item.id,'businessBonus',e.target.value)}/></td>
                                                <td className="p-1"><input type="text" className="w-10 border" value={item.sickLeave} onChange={e=>updateVal(item.id,'sickLeave',e.target.value)}/></td>
                                                <td className="p-1"><input type="text" className="w-10 border" value={item.personalLeave} onChange={e=>updateVal(item.id,'personalLeave',e.target.value)}/></td>
                                                <td className="p-1"><input type="number" className="w-12 border" value={item.deduction} onChange={e=>updateVal(item.id,'deduction',e.target.value)}/></td>
                                                <td className="p-2 sticky right-0 bg-white font-bold text-blue-700">${item.netPay.toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {activeTab === 'print' && (
                            <div className="print-block">
                                <div className="mb-4 flex justify-between print-hidden bg-white p-4 rounded shadow">
                                    <h2 className="text-xl font-bold">薪資單</h2>
                                    <button onClick={()=>window.print()} className="px-4 py-2 bg-slate-800 text-white rounded">列印</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 print-grid-2">
                                    {fullPayrollList.map(item => (
                                        <div key={item.id} className="bg-white border p-4 shadow-sm break-inside-avoid print:border-black" style={{minHeight:'200px'}}>
                                            <div className="flex justify-between border-b pb-1 mb-2">
                                                <span className="font-bold text-lg">{item.name} <span className="text-xs font-normal">({item.empId})</span></span>
                                                <span className="text-sm">{item.period}</span>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2 text-xs">
                                                <div className="border-r pr-2">
                                                    <div className="font-bold text-slate-500 mb-1">應發項目 (+)</div>
                                                    <div className="flex justify-between"><span>本薪</span><span>{item.baseSalary}</span></div>
                                                    {item.payWt034>0 && <div className="flex justify-between text-blue-700"><span>平日(0.34) {item.wt034}</span><span>{item.payWt034}</span></div>}
                                                    {item.payWt067>0 && <div className="flex justify-between text-blue-700"><span>平日(0.67) {item.wt067}</span><span>{item.payWt067}</span></div>}
                                                    {item.payHd134>0 && <div className="flex justify-between text-purple-700"><span>例假(1.34) {item.hd134}</span><span>{item.payHd134}</span></div>}
                                                    {item.payHd167>0 && <div className="flex justify-between text-purple-700"><span>例假(1.67) {item.hd167}</span><span>{item.payHd167}</span></div>}
                                                    {item.payEarly>0 && <div className="flex justify-between"><span>提早(0.34) {item.earlyShift}</span><span>{item.payEarly}</span></div>}
                                                    {item.payNoLunch>0 && <div className="flex justify-between"><span>未休(0.34) {item.noLunch}</span><span>{item.payNoLunch}</span></div>}
                                                    {item.payHolidayOT>0 && <div className="flex justify-between"><span>休加(1.34) {item.holidayOT}</span><span>{item.payHolidayOT}</span></div>}
                                                    {item.payAnnual>0 && <div className="flex justify-between text-emerald-700"><span>特休補薪 {item.annualLeave}</span><span>{item.payAnnual}</span></div>}
                                                    {item.lunchAllowance>0 && <div className="flex justify-between text-green-700"><span>午餐津貼</span><span>{item.lunchAllowance}</span></div>}
                                                    {item.businessBonus>0 && <div className="flex justify-between text-green-700"><span>業務加給</span><span>{item.businessBonus}</span></div>}
                                                    <div className="border-t mt-1 pt-1 font-bold flex justify-between"><span>應發合計</span><span>{item.grossPay}</span></div>
                                                </div>
                                                <div className="pl-1">
                                                    <div className="font-bold text-slate-500 mb-1">應扣項目 (-)</div>
                                                    <div className="flex justify-between text-red-700"><span>勞健保</span><span>{item.insuranceFee}</span></div>
                                                    {item.dedAbsence>0 && <div className="flex justify-between text-red-900"><span>缺勤扣款 {item.absenceHours}</span><span>{item.dedAbsence}</span></div>}
                                                    {item.dedSick>0 && <div className="flex justify-between text-red-600"><span>病假(0.5) {item.sickLeave}</span><span>{item.dedSick}</span></div>}
                                                    {item.dedPersonal>0 && <div className="flex justify-between text-red-800"><span>事/颱(1.0) {item.personalLeave}</span><span>{item.dedPersonal}</span></div>}
                                                    <div className="border-t mt-1 pt-1 font-bold flex justify-between"><span>應扣合計</span><span>{item.finalDeduction}</span></div>
                                                </div>
                                            </div>
                                            <div className="mt-2 pt-2 border-t flex justify-between items-end">
                                                <div className="text-xs text-gray-500 w-2/3 truncate">{item.note}</div>
                                                <div className="text-right">
                                                    <div className="text-xs text-gray-400 mb-1">工時: {item.actualWorkHours} / 應勤: {item.expectedHours}</div>
                                                    <span className="text-xs mr-1">實發</span><span className="text-xl font-bold font-mono">${item.netPay.toLocaleString()}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Modals: Import, Edit, Bulk - Same logic as before but updated fields if needed */}
                        {isImportModalOpen && <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div className="bg-white p-6 rounded shadow-xl w-full max-w-lg"><h3 className="font-bold text-lg mb-4">匯入 Excel</h3><input type="file" ref={fileInputRef} accept=".xlsx,.csv" onChange={handleExcel} className="border p-2 w-full"/><button onClick={()=>setIsImportModalOpen(false)} className="mt-4 px-4 py-2 bg-gray-200 rounded">關閉</button></div></div>}
                        {isEmpModalOpen && <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div className="bg-white p-6 rounded shadow-xl w-full max-w-sm"><h3 className="font-bold text-lg mb-4">編輯員工</h3><form onSubmit={handleSaveEmployee} className="space-y-3"><input name="empId" defaultValue={editingEmp?.empId} placeholder="ID" className="border p-2 w-full"/><input name="name" defaultValue={editingEmp?.name} placeholder="姓名" className="border p-2 w-full"/><input name="baseSalary" type="number" defaultValue={editingEmp?.baseSalary} placeholder="底薪" className="border p-2 w-full"/><div className="flex justify-end gap-2"><button type="button" onClick={()=>setIsEmpModalOpen(false)} className="px-3 py-1 border rounded">取消</button><button className="px-3 py-1 bg-blue-600 text-white rounded">儲存</button></div></form></div></div>}
                        {isBulkModalOpen && <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50"><div className="bg-white p-6 rounded shadow-xl w-full max-w-sm"><h3 className="font-bold text-lg mb-4">批量調薪</h3><form onSubmit={handleBulkSubmit} className="space-y-3"><input type="number" value={bulkTargetSalary} onChange={e=>setBulkTargetSalary(e.target.value)} className="border p-2 w-full" placeholder="新底薪"/><div className="flex justify-end gap-2"><button type="button" onClick={()=>setIsBulkModalOpen(false)} className="px-3 py-1 border rounded">取消</button><button className="px-3 py-1 bg-orange-600 text-white rounded">執行</button></div></form></div></div>}

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PayrollApp />);
    </script>
</body>
</html>