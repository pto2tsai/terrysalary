<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è–ªè³‡ç®¡ç†ç³»çµ± (V36.7 - æ¬„ä½æ™‚æ•¸ä¿®æ­£ç‰ˆ)</title>
    
    <!-- 1. å¼•å…¥æ¨£å¼èˆ‡æ ¸å¿ƒåº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- 2. å¼•å…¥ Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken, 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            deleteDoc, 
            onSnapshot,
            query,
            orderBy
        };
    </script>

    <style>
        /* åŸºç¤æ¨£å¼ */
        body { background-color: #525252; color: #1f2937; font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; -webkit-tap-highlight-color: transparent; }
        input, select, button { touch-action: manipulation; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* --- è–ªè³‡å–®å¡ç‰‡æ¨£å¼ (å…±ç”¨) --- */
        .payroll-slip-style {
            background: white;
            border: 3px double #000; /* å°ˆæ¥­é›™ç·šé‚Šæ¡† */
            padding: 10px 15px; /* ä¸Šä¸‹å…§è·ç¸®å°ï¼Œçˆ­å–ç©ºé–“ */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            color: #000;
            position: relative;
            width: 100%;
            overflow: hidden; /* é—œéµï¼šé˜²æ­¢å…§å®¹æº¢å‡ºç ´å£ç‰ˆé¢ */
        }

        /* --- å­—é«”èˆ‡æ’ç‰ˆè¨­å®š (V36.4 è¨­å®šä¿æŒ) --- */
        .slip-title { 
            font-size: 30px !important; 
            font-weight: 900 !important; 
            text-align: center; 
            border-bottom: 3px solid #000; 
            margin-bottom: 5px; 
            padding-bottom: 2px; 
            letter-spacing: 2px; 
            line-height: 1.1;
        }
        
        .emp-info-row {
            display: flex; 
            justify-content: space-between; 
            align-items: baseline; 
            border-bottom: 1px dashed #000; 
            padding-bottom: 4px; 
            margin-bottom: 8px;
        }
        .emp-name { font-size: 24px !important; font-weight: 900 !important; }
        .emp-id { font-size: 14px !important; font-weight: 600; margin-left: 6px; }
        .emp-dept { font-size: 16px !important; font-weight: 800; }

        /* æ ¸å¿ƒäºŒæ¬„å¼ä½ˆå±€ */
        .body-grid { 
            display: grid; 
            grid-template-columns: 1fr 1px 1fr; 
            gap: 10px; 
            flex-grow: 1; 
        }
        .body-divider { background-color: #000; width: 1px; height: 100%; }

        .section-title { 
            font-size: 15px !important; 
            font-weight: 900 !important; 
            text-decoration: underline; 
            margin-bottom: 4px; 
            text-align: center;
        }

        /* é …ç›®è¡Œï¼šå·¦å°é½Šåç¨±ï¼Œå³å°é½Šé‡‘é¡ */
        .item-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            line-height: 1.3; 
            margin-bottom: 1px; /* æ¥µçª„è¡Œè· */
        }
        .item-label { font-size: 14px !important; font-weight: 700 !important; text-align: left; }
        .item-value { font-size: 16px !important; font-weight: 800 !important; font-family: Consolas, monospace; text-align: right; }
        
        /* åˆè¨ˆè¡Œ */
        .subtotal-row {
            border-top: 2px solid #000;
            margin-top: 4px;
            padding-top: 2px;
            display: flex;
            justify-content: space-between;
            font-weight: 900;
            font-size: 15px !important;
        }

        .footer {
            margin-top: auto;
            border-top: 3px double #000;
            padding-top: 4px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .footer-main { display: flex; justify-content: space-between; alignItems: flex-end; width: 100%; }
        .footer-info { font-size: 11px !important; font-weight: 600; line-height: 1.3; width: 100%; }
        
        .net-pay-label { font-size: 18px !important; font-weight: 800; margin-right: 5px; }
        .net-pay-value { 
            font-size: 32px !important; 
            font-weight: 900; 
            font-family: Consolas, monospace; 
            border-bottom: 4px double #000; 
            line-height: 1;
        }
        
        /* å‡åˆ¥é¡¯ç¤º */
        .footer-leaves { margin-top: 4px; padding-top: 4px; border-top: 1px dotted #999; font-size: 12px !important; font-weight: 600; color: #333; }

        /* --- è¢å¹•é è¦½å°ˆç”¨ --- */
        @media screen {
            .print-page-wrapper { display: flex; flex-direction: column; align-items: center; gap: 30px; padding: 20px; }
            .print-page { width: 210mm; height: 296mm; background: white; padding: 5mm; box-sizing: border-box; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 5mm; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); }
            @media (max-width: 1023px) {
                .print-page-wrapper { padding: 10px; gap: 10px; }
                .print-page { width: 100%; height: auto; display: grid; grid-template-columns: 1fr; gap: 15px; box-shadow: none; background: transparent; padding: 0; }
                .payroll-slip-style { height: auto !important; min-height: 400px; border: 1px solid #ccc; }
            }
        }

        /* --- åˆ—å°æ¨£å¼ (A4 4å¼µ æ»¿ç‰ˆ) --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background-color: white; margin: 0; padding: 0; }
            body * { visibility: hidden; }
            #print-container-root, #print-container-root * { visibility: visible; }
            #print-container-root { position: absolute; left: 0; top: 0; width: 100%; }
            .print-page { width: 210mm; height: 296mm; padding: 5mm; box-sizing: border-box; display: grid !important; grid-template-columns: 1fr 1fr !important; grid-template-rows: 1fr 1fr !important; gap: 5mm !important; page-break-after: always; break-after: page; }
            .print-page:last-child { page-break-after: auto; break-after: auto; }
            .payroll-slip-style { width: 100% !important; height: 142mm !important; box-shadow: none !important; margin: 0 !important; border: 3px double #000 !important; }
            nav, .mobile-nav, button, .no-print, #loading-screen, #error-display { display: none !important; }
        }
        
        .input-locked { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; border-color: #e5e7eb; }
        .checkbox-cell { width: 40px; text-align: center; }
        .checkbox-input { width: 18px; height: 18px; cursor: pointer; }
        .offline-badge { background-color: #ef4444; color: white; font-size: 12px; padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; }
    </style>
</head>
<body class="pb-20 md:pb-0">

    <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500">æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // 1. Firebase Config
        const USER_FIREBASE_CONFIG = {
          apiKey: "AIzaSyDvu-VONOJoj251pMPMXRfT_L4uVDJS4Q8",
          authDomain: "terrysalary.firebaseapp.com",
          projectId: "terrysalary",
          storageBucket: "terrysalary.firebasestorage.app",
          messagingSenderId: "556461050986",
          appId: "1:556461050986:web:7a8f13d3d9adb5f77d0e13"
        };

        // 2. Global Helper Functions
        function formatNumber(num) {
            if (num === undefined || num === null || num === '') return '0';
            const n = Number(num);
            return isNaN(n) ? "0" : n.toLocaleString();
        }

        function getTitle(period) {
            if (!period) return "";
            const parts = period.split('-');
            if (parts.length < 2) return period;
            return `${parts[0]}å¹´${parts[1]}æœˆ`;
        }
        
        function safeNum(val) { const num = Number(val); return isNaN(num) ? 0 : num; }
        function timeStrToHours(str) { if (!str) return 0; const [h, m] = String(str).split(':').map(Number); return (safeNum(h)) + (safeNum(m))/60; }
        function hoursToTimeStr(hours) { if (!hours && hours !== 0) return "00:00"; const h = Math.floor(hours); const m = Math.round((hours - h) * 60); return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`; }
        function formatInputTime(val) {
            if(!val) return "00:00"; val = String(val).trim();
            if (val.includes('.')) { const num = parseFloat(val); const h = Math.floor(num); const m = Math.round((num - h) * 60); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
            if (!val.includes(':')) { if (val.length <= 2) return `${val.padStart(2,'0')}:00`; if (val.length === 3) return `0${val[0]}:${val.substring(1)}`; if (val.length === 4) return `${val.substring(0,2)}:${val.substring(2)}`; }
            const parts = val.split(':'); return `${String(parseInt(parts[0])||0).padStart(2,'0')}:${String(parseInt(parts[1])||0).padStart(2,'0')}`;
        }
        function excelTimeToString(val) { if (typeof val === 'number') { const t = val * 24; const h = Math.floor(t); const m = Math.round((t - h) * 60); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; } return formatInputTime(val); }
        
        // V36.3: å‡åˆ¥è‡ªå‹•åˆ¤è®€
        function parseLeave(note) {
            let sickHours=0, personalHours=0, annualHours=0, bereavementHours=0;
            if (!note) return { sickLeave: "00:00", personalLeave: "00:00", annualLeave: "00:00", bereavementLeave: "00:00" };
            const str = note.toString();
            const regex = /(ç—…å‡|äº‹å‡|æ› è·|æ‰£è–ª|ç‰¹ä¼‘|å¹´å‡|å–ªå‡)\s*(\d+)([:\.](\d+))?/gi;
            let match;
            while ((match = regex.exec(str)) !== null) {
                const type = match[1];
                const hours = parseInt(match[2]) || 0;
                const minutes = parseInt(match[4]) || 0;
                const totalHours = hours + minutes / 60;
                if (type.includes("ç‰¹ä¼‘") || type.includes("å¹´å‡")) annualHours += totalHours;
                else if (type.includes("ç—…å‡")) sickHours += totalHours;
                else if (type.includes("äº‹å‡") || type.includes("æ‰£è–ª") || type.includes("æ› è·")) personalHours += totalHours;
                else if (type.includes("å–ªå‡")) bereavementHours += totalHours;
            }
            return { sickLeave: hoursToTimeStr(sickHours), personalLeave: hoursToTimeStr(personalHours), annualLeave: hoursToTimeStr(annualHours), bereavementLeave: hoursToTimeStr(bereavementHours) };
        }

        function chunkArray(array, size) {
            const chunked = [];
            for (let i = 0; i < array.length; i += size) chunked.push(array.slice(i, i + size));
            return chunked;
        }

        // 3. Salary Calculation
        function calculateSalary(emp, data) {
            if (!emp) return null;
            const d = data || {};
            const hourlyRate = Math.round(safeNum(emp.baseSalary) / 240);
            
            const payWt034 = Math.round(timeStrToHours(d.wt034) * 1.34 * hourlyRate);
            const payWt067 = Math.round(timeStrToHours(d.wt067) * 1.67 * hourlyRate);
            const payHd134 = Math.round(timeStrToHours(d.hd134) * 1.34 * hourlyRate);
            const payHd167 = Math.round(timeStrToHours(d.hd167) * 1.67 * hourlyRate);
            const payEarly = Math.round(timeStrToHours(d.earlyShift) * 1.34 * hourlyRate); 
            const payNoLunch = Math.round(timeStrToHours(d.noLunch) * 1.34 * hourlyRate); 
            const payHolidayOT = Math.round(timeStrToHours(d.holidayOT) * 1.34 * hourlyRate);
            const payAnnual = 0; 
            const allowances = safeNum(d.lunchAllowance) + safeNum(d.businessBonus) + safeNum(d.otherBonus);
            const totalAdditions = payWt034 + payWt067 + payHd134 + payHd167 + payEarly + payNoLunch + payHolidayOT + allowances;
            const grossPay = safeNum(emp.baseSalary) + totalAdditions;

            const dedSick = Math.round(timeStrToHours(d.sickLeave) * 0.5 * hourlyRate);
            const dedPersonal = Math.round(timeStrToHours(d.personalLeave) * 1.0 * hourlyRate);
            
            const expectedHoursVal = timeStrToHours(d.expectedWorkHours); 
            const actualHoursVal = timeStrToHours(d.actualWorkHours);
            
            let calcLateHoursVal = 0;
            if (expectedHoursVal > 0 && actualHoursVal < expectedHoursVal) {
                calcLateHoursVal = expectedHoursVal - actualHoursVal;
            }
            
            const dedLate = Math.round(calcLateHoursVal * 1.0 * hourlyRate); // é²åˆ°æ‰£æ¬¾ (å…¨é¡)
            const dedAbsent = Math.round(timeStrToHours(d.absentTime) * 1.0 * hourlyRate); // æ› è·æ‰£æ¬¾ (æ‰‹å‹•è¼¸å…¥)

            let insuranceFee = d.hasImportedInsurance ? safeNum(d.deduction) : (safeNum(emp.laborFee) + safeNum(emp.healthFee));
            let finalDeduction = dedSick + dedPersonal + dedLate + dedAbsent + insuranceFee + (d.hasImportedInsurance ? 0 : safeNum(d.deduction));
            
            return { 
                hourlyRate, payWt034, payWt067, payHd134, payHd167, payEarly, payNoLunch, payHolidayOT, 
                dedSick, dedPersonal, dedLate, dedAbsent, 
                calcLateHoursVal,
                calcLateHoursStr: hoursToTimeStr(calcLateHoursVal), 
                expectedHoursVal, 
                totalAdditions, finalDeduction, netPay: grossPay - finalDeduction, insuranceFee, grossPay 
            };
        }
        
        // 4. MobileNav Component
        const MobileNav = ({ activeTab, setActiveTab }) => (
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around py-3 pb-safe shadow-lg z-50 md:hidden no-print">
                <button onClick={() => setActiveTab('employees')} className={`flex flex-col items-center ${activeTab === 'employees' ? 'text-blue-600' : 'text-gray-400'}`}>
                    <Icons.Users className="w-6 h-6" />
                    <span className="text-xs mt-1">å“¡å·¥</span>
                </button>
                <button onClick={() => setActiveTab('input')} className={`flex flex-col items-center ${activeTab === 'input' ? 'text-blue-600' : 'text-gray-400'}`}>
                    <Icons.Calculator className="w-6 h-6" />
                    <span className="text-xs mt-1">çµç®—</span>
                </button>
                <button onClick={() => setActiveTab('print')} className={`flex flex-col items-center ${activeTab === 'print' ? 'text-blue-600' : 'text-gray-400'}`}>
                    <Icons.Printer className="w-6 h-6" />
                    <span className="text-xs mt-1">åˆ—å°</span>
                </button>
            </div>
        );

        // 5. Icons (Fix: Simplified Settings Icon to avoid string truncation)
        const Icons = {
            Calculator: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Users: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Printer: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            Plus: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M5 12h14M12 5v14"/></svg>,
            Trash2: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Settings: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Upload: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Clock: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            FileSpreadsheet: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
            RefreshCw: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>,
            Edit: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Download: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Lock: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Cloud: (p)=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
            ChevronRight: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="9 18 15 12 9 6"/></svg>,
            X: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        };

        const INITIAL_EMPLOYEES = [{ id: 1, name: 'ç¯„ä¾‹-å¼µè€€å‡', empId: 'W0001', baseSalary: 28590, laborFee: 1100, healthFee: 750, title: 'ä½œæ¥­å“¡', department: 'ç”Ÿç”¢éƒ¨', lastRaiseDate: '2024-01-01' }];
        const INITIAL_PAYROLL_DATA = [{ empId: 1, period: '2025-11', wt034:"00:00", wt067:"00:00", hd134:"00:00", hd167:"00:00", earlyShift:"00:00", noLunch:"00:00", holidayOT:"00:00", sickLeave:"00:00", personalLeave:"00:00", annualLeave:"00:00", bereavementLeave:"00:00", lunchAllowance:0, businessBonus:0, otherBonus:0, deduction:0, expectedWorkHours:"00:00", actualWorkHours:"160:00", note:'' }];

        const PayrollApp = () => {
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [appId, setAppId] = useState(null);
            const [isCloudReady, setIsCloudReady] = useState(false);
            const [isOffline, setIsOffline] = useState(false); 

            const safeParse = (key, defaultVal) => { try { return JSON.parse(localStorage.getItem(key)) || defaultVal; } catch(e) { return defaultVal; } };
            const [activeTab, setActiveTab] = useState('input');
            const [employees, setEmployees] = useState(() => safeParse('payroll_employees', INITIAL_EMPLOYEES));
            const [payrollData, setPayrollData] = useState(() => safeParse('payroll_data', INITIAL_PAYROLL_DATA));
            const [monthlyStatus, setMonthlyStatus] = useState(() => safeParse('payroll_status', {}));
            const [currentPeriod, setCurrentPeriod] = useState(new Date().toISOString().slice(0, 7));
            
            const [editingEmp, setEditingEmp] = useState(null);
            const [isEmpModalOpen, setIsEmpModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [isBulkModalOpen, setIsBulkModalOpen] = useState(false);
            const [mobileEditItem, setMobileEditItem] = useState(null);

            const [bulkTargetSalary, setBulkTargetSalary] = useState(29500);
            const [bulkFilterType, setBulkFilterType] = useState('salary');
            const [bulkFilterValue, setBulkFilterValue] = useState(28590);
            const fileInputRef = useRef(null);
            
            // æ–°å¢ï¼šå‹¾é¸ç‹€æ…‹
            const [selectedEmpIds, setSelectedEmpIds] = useState(new Set());

            // Firebase Init
            useEffect(() => {
                const initFirebase = async () => {
                    while (!window.firebaseModules) { await new Promise(resolve => setTimeout(resolve, 100)); }
                    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore } = window.firebaseModules;
                    try {
                        const app = initializeApp(USER_FIREBASE_CONFIG);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        setAppId("terrysalary");
                        setDb(firestore);

                        await signInAnonymously(auth);
                        onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            setIsCloudReady(true);
                            document.getElementById('loading-screen').style.display = 'none';
                        });
                    } catch (error) {
                        console.error("Firebase Init Failed", error);
                        setIsCloudReady(false); 
                        document.getElementById('loading-screen').style.display = 'none';
                        setIsOffline(true);
                    }
                };
                initFirebase();
            }, []);

            // Data Sync (Only run once to prevent quota exceeded)
            useEffect(() => {
                if (isCloudReady && db && user?.uid && !isOffline) {
                    const { collection, onSnapshot } = window.firebaseModules;
                    
                    const handleError = (err) => {
                        console.error("Firestore Error:", err);
                        if (err.code === 'resource-exhausted') {
                            alert("âš ï¸ é›²ç«¯è®€å–é¡åº¦å·²ç”¨ç›¡ï¼Œç³»çµ±å·²è‡ªå‹•åˆ‡æ›è‡³ã€Œé›¢ç·šæ¨¡å¼ã€ã€‚");
                            setIsOffline(true);
                        }
                    };

                    const empUnsub = onSnapshot(collection(db, 'payroll_system', user.uid, 'employees'), (snap) => { const list = snap.docs.map(d => d.data()); if(list.length > 0) setEmployees(list); }, handleError);
                    const payUnsub = onSnapshot(collection(db, 'payroll_system', user.uid, 'payroll'), (snap) => { const list = snap.docs.map(d => d.data()); if(list.length > 0) setPayrollData(list); }, handleError);
                    const statUnsub = onSnapshot(collection(db, 'payroll_system', user.uid, 'status'), (snap) => { const obj = {}; snap.docs.forEach(d => obj[d.id] = d.data().status); setMonthlyStatus(obj); }, handleError);
                    return () => { empUnsub(); payUnsub(); statUnsub(); };
                } 
            }, [isCloudReady, db, user?.uid, isOffline]);

            // Local Backup
            useEffect(() => {
                localStorage.setItem('payroll_employees', JSON.stringify(employees));
                localStorage.setItem('payroll_data', JSON.stringify(payrollData));
                localStorage.setItem('payroll_status', JSON.stringify(monthlyStatus));
            }, [employees, payrollData, monthlyStatus]);

            // Sorted Employees
            const sortedEmployees = useMemo(() => {
                return [...employees].sort((a, b) => {
                    const idA = a.empId || "";
                    const idB = b.empId || "";
                    return idB.localeCompare(idA, undefined, { numeric: true, sensitivity: 'base' });
                });
            }, [employees]);

            // Chunk array helper for pagination
            const chunkedPayrollList = useMemo(() => {
                const fullList = sortedEmployees.map(emp => {
                    let data = payrollData.find(d => d.empId === emp.empId && d.period === currentPeriod) || { empId: emp.empId, period: currentPeriod };
                    const safeData = {
                        wt034: data.wt034||"00:00", wt067: data.wt067||"00:00", hd134: data.hd134||"00:00", hd167: data.hd167||"00:00",
                        earlyShift: data.earlyShift||"00:00", noLunch: data.noLunch||"00:00", holidayOT: data.holidayOT||"00:00",
                        sickLeave: data.sickLeave||"00:00", personalLeave: data.personalLeave||"00:00", annualLeave: data.annualLeave||"00:00", bereavementLeave: data.bereavementLeave||"00:00",
                        lateTime: data.lateTime||"00:00", absentTime: data.absentTime||"00:00", 
                        lunchAllowance: data.lunchAllowance||0, businessBonus: data.businessBonus||0, otherBonus: data.otherBonus||0,
                        deduction: data.deduction||0, note: data.note||'', hasImportedInsurance: data.hasImportedInsurance,
                        expectedWorkHours: data.expectedWorkHours||"00:00", actualWorkHours: data.actualWorkHours||"00:00"
                    };
                    return { ...emp, ...safeData, ...calculateSalary(emp, safeData) };
                });
                return chunkArray(fullList, 4); 
            }, [sortedEmployees, payrollData, currentPeriod]);

            const fullPayrollListFlat = useMemo(() => sortedEmployees.map(emp => {
                 let data = payrollData.find(d => d.empId === emp.empId && d.period === currentPeriod) || { empId: emp.empId, period: currentPeriod };
                const safeData = {
                    wt034: data.wt034||"00:00", wt067: data.wt067||"00:00", hd134: data.hd134||"00:00", hd167: data.hd167||"00:00",
                    earlyShift: data.earlyShift||"00:00", noLunch: data.noLunch||"00:00", holidayOT: data.holidayOT||"00:00",
                    sickLeave: data.sickLeave||"00:00", personalLeave: data.personalLeave||"00:00", annualLeave: data.annualLeave||"00:00", bereavementLeave: data.bereavementLeave||"00:00",
                    lateTime: data.lateTime||"00:00", absentTime: data.absentTime||"00:00", // æ–°å¢
                    lunchAllowance: data.lunchAllowance||0, businessBonus: data.businessBonus||0, otherBonus: data.otherBonus||0,
                    deduction: data.deduction||0, note: data.note||'', hasImportedInsurance: data.hasImportedInsurance,
                    expectedWorkHours: data.expectedWorkHours||"00:00", actualWorkHours: data.actualWorkHours||"00:00"
                };
                return { ...emp, ...safeData, ...calculateSalary(emp, safeData) };
            }), [sortedEmployees, payrollData, currentPeriod]);

            // CRUD
            const saveEmp = async (emp) => { 
                if (db && user && !isOffline) { 
                    try {
                        const { doc, setDoc } = window.firebaseModules; 
                        await setDoc(doc(db, 'payroll_system', user.uid, 'employees', String(emp.id)), emp); 
                    } catch(e) { console.error(e); setIsOffline(true); } 
                } 
                const newEmps = employees.some(e=>e.id===emp.id) ? employees.map(e=>e.id===emp.id?emp:e) : [...employees, emp]; 
                setEmployees(newEmps); 
            };

            const delEmp = async (id) => { 
                if (db && user && !isOffline) { 
                    try {
                        const { doc, deleteDoc } = window.firebaseModules; 
                        await deleteDoc(doc(db, 'payroll_system', user.uid, 'employees', String(id))); 
                    } catch(e) { console.error(e); setIsOffline(true); }
                } 
                setEmployees(prev => prev.filter(e=>e.id!==id)); 
            };

            const savePay = async (data) => { 
                if (db && user && !isOffline) { 
                    try {
                        const { doc, setDoc } = window.firebaseModules; 
                        const key = `${data.empId}_${data.period}`; 
                        await setDoc(doc(db, 'payroll_system', user.uid, 'payroll', key), data); 
                    } catch(e) { console.error(e); setIsOffline(true); }
                } 
                setPayrollData(prev => { const idx = prev.findIndex(p=>p.empId===data.empId && p.period===data.period); if(idx>=0) { const n=[...prev]; n[idx]=data; return n; } return [...prev, data]; }); 
            };

            const saveStat = async (period, status) => { 
                if (db && user && !isOffline) { 
                    try {
                        const { doc, setDoc } = window.firebaseModules; 
                        await setDoc(doc(db, 'payroll_system', user.uid, 'status', period), { status }); 
                    } catch(e) { console.error(e); setIsOffline(true); }
                } 
                setMonthlyStatus(prev => ({...prev, [period]: status})); 
            };

            const isLocked = monthlyStatus[currentPeriod] === 'locked';
            const toggleLock = () => { if(confirm(`ç¢ºå®šè¦${isLocked?'è§£é™¤çµæ¡ˆ':'çµæ¡ˆ'}?`)) saveStat(currentPeriod, isLocked?'active':'locked'); };

            const updateVal = (empId, field, value) => {
                if (isLocked) return;
                const val = (['note', 'wt034','wt067','hd134','hd167','earlyShift','noLunch','holidayOT','sickLeave','personalLeave','annualLeave','actualWorkHours', 'expectedWorkHours', 'lateTime', 'absentTime'].includes(field)) ? value : Number(value);
                const existing = payrollData.find(p => p.empId === empId && p.period === currentPeriod);
                const newData = existing ? { ...existing, [field]: val } : { empId, period: currentPeriod, [field]: val };
                if (field === 'deduction') newData.hasImportedInsurance = false;
                savePay(newData);
            };
            const handleTimeBlur = (empId, field, value) => updateVal(empId, field, formatInputTime(value));
            
            // Checkbox
            const toggleSelectAll = () => { if (selectedEmpIds.size === sortedEmployees.length) setSelectedEmpIds(new Set()); else setSelectedEmpIds(new Set(sortedEmployees.map(e => e.id))); };
            const toggleSelect = (id) => { const newSet = new Set(selectedEmpIds); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); setSelectedEmpIds(newSet); };

            // Excel Import (V36.5 Fix: Ensure 'headers' is defined)
            const handleExcel = (e) => {
                if (isLocked) { alert("æœ¬æœˆå·²çµæ¡ˆ"); return; }
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: "" });
                        let hRow = -1; for(let i=0; i<Math.min(data.length, 20); i++) { if(JSON.stringify(data[i]).includes("å“¡å·¥ç·¨è™Ÿ")) { hRow = i; break; } }
                        if(hRow === -1) throw new Error("æ‰¾ä¸åˆ°æ¨™é¡Œåˆ—");
                        const rows = data.slice(hRow+1);
                        
                        // FIX: Define headers correctly
                        const headers = data[hRow];
                        
                        const idx = { id:-1, name:-1, wt034:-1, wt067:-1, hd134:-1, hd167:-1, early:-1, noLunch:-1, holidayOT:-1, lunch:-1, bonus:-1, ins:-1, note:-1, expHours:-1, actHours:-1, annual:-1, dept:-1, base:-1 };
                        headers.forEach((h, i) => {
                            const t = String(h).trim();
                            if(t.includes("å“¡å·¥ç·¨è™Ÿ")) idx.id = i; else if(t.includes("å“¡å·¥å§“å")) idx.name = i; else if(t.includes("éƒ¨é–€")) idx.dept = i; else if(t.includes("åŸºæœ¬åº•è–ª")||(t.includes("åº•è–ª")&&!t.includes("å¯¦ç™¼"))) idx.base = i;
                            else if(t.includes("æå‰")) idx.early = i; else if(t.includes("ä¸­åˆ")) idx.noLunch = i; else if(t.includes("æ˜ŸæœŸæ—¥")) idx.holidayOT = i;
                            else if(t.includes("åˆé¤")||t.includes("è£œåŠ©")) idx.lunch = i; else if(t.includes("æ¥­å‹™")||t.includes("è·å‹™")) idx.bonus = i;
                            else if(t.includes("å‹å¥ä¿")) idx.ins = i; else if(t.includes("å‚™è¨»")) idx.note = i;
                            else if(t.includes("æ‡‰ä¸Šç­")) idx.expHours = i; // V36.4 æ–°å¢
                            else if(t.includes("å¯¦ä¸Šç­")||t.includes("å¯¦éš›å‡ºå‹¤")) { if(t.includes("æ™‚æ•¸")) idx.actHours = i; }
                            else if(t.includes("ç‰¹ä¼‘")&&!t.includes("å‚™è¨»")) idx.annual = i; 
                            if(t.includes("å¹³æ—¥")&&(t.includes("0.34")||t.includes("0.33"))&&idx.wt034===-1) idx.wt034=i;
                            if(t.includes("å¹³æ—¥")&&(t.includes("0.67")||t.includes("0.66"))&&idx.wt067===-1) idx.wt067=i;
                            if((t.includes("ä¾‹å‡")||t.includes("å‡æ—¥"))&&(t.includes("1.34")||t.includes("1.33"))&&idx.hd134===-1) idx.hd134=i;
                            if((t.includes("ä¾‹å‡")||t.includes("å‡æ—¥"))&&(t.includes("1.67")||t.includes("1.66"))&&idx.hd167===-1) idx.hd167=i;
                        });
                        let count = 0;
                        const promises = rows.map(async row => {
                            const eid = String(row[idx.id]||"").trim(); if(!eid) return;
                            let emp = employees.find(e => e.empId === eid);
                            let baseSalary = idx.base!==-1 ? (parseInt(row[idx.base])||28590) : 28590;
                            if(!emp) { 
                                emp = { id: Date.now()+Math.random(), empId: eid, name: String(row[idx.name]||""), baseSalary: baseSalary, laborFee:0, healthFee:0, title:"å“¡å·¥", department: String(row[idx.dept]||""), lastRaiseDate: new Date().toISOString().split('T')[0] }; 
                                await saveEmp(emp);
                            } else {
                                let updated = false;
                                if(idx.dept!==-1 && row[idx.dept] && emp.department!==String(row[idx.dept])) { emp.department = String(row[idx.dept]); updated = true; }
                                if(idx.base!==-1 && row[idx.base] && emp.baseSalary!==baseSalary) { emp.baseSalary = baseSalary; updated = true; }
                                if(updated) await saveEmp(emp);
                            }
                            if(emp) {
                                const noteText = String(row[idx.note]||"");
                                // V36.3: æå–å‡åˆ¥æ™‚æ•¸
                                const leaves = parseLeave(noteText); 
                                
                                const entry = { 
                                    empId: emp.empId, period: currentPeriod, 
                                    wt034: idx.wt034!==-1?excelTimeToString(row[idx.wt034]):"00:00", 
                                    wt067: idx.wt067!==-1?excelTimeToString(row[idx.wt067]):"00:00", 
                                    hd134: idx.hd134!==-1?excelTimeToString(row[idx.hd134]):"00:00", 
                                    hd167: idx.hd167!==-1?excelTimeToString(row[idx.hd167]):"00:00", 
                                    earlyShift: excelTimeToString(row[idx.early]), 
                                    noLunch: excelTimeToString(row[idx.noLunch]), 
                                    holidayOT: excelTimeToString(row[idx.holidayOT]), 
                                    lunchAllowance: parseInt(row[idx.lunch])||0, 
                                    businessBonus: parseInt(row[idx.bonus])||0, 
                                    deduction: parseInt(row[idx.ins])||0, 
                                    hasImportedInsurance: !!(parseInt(row[idx.ins])), 
                                    expectedWorkHours: idx.expHours !== -1 ? excelTimeToString(row[idx.expHours]) : "00:00", // V36.4
                                    actualWorkHours: excelTimeToString(row[idx.actHours]), 
                                    lateTime: "00:00", 
                                    absentTime: "00:00", 
                                    ...leaves, 
                                    note: noteText 
                                };
                                await savePay(entry); count++;
                            }
                        });
                        Promise.all(promises).then(() => { setIsImportModalOpen(false); alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡æ–™ï¼`); });
                    } catch(err) { console.error(err); alert("åŒ¯å…¥å¤±æ•—"); }
                    if(fileInputRef.current) fileInputRef.current.value = '';
                };
                reader.readAsBinaryString(file);
            };

            const handleSaveEmployee = async (e) => { e.preventDefault(); const fd = new FormData(e.target); const newEmp = { id: editingEmp?editingEmp.id:Date.now(), name: fd.get('name'), empId: fd.get('empId'), title: fd.get('title'), department: fd.get('department'), baseSalary: Number(fd.get('baseSalary')), laborFee: Number(fd.get('laborFee')), healthFee: Number(fd.get('healthFee')), lastRaiseDate: fd.get('lastRaiseDate') || new Date().toISOString().split('T')[0] }; await saveEmp(newEmp); setIsEmpModalOpen(false); };
            const deleteEmployee = (id) => { if(confirm('åˆªé™¤?')) delEmp(id); };
            const handleBulkSubmit = async (e) => { 
                e.preventDefault(); const target = Number(bulkTargetSalary); if(!target) return; 
                const today = new Date().toISOString().split('T')[0]; let c=0; 
                const targets = selectedEmpIds.size > 0 ? employees.filter(e => selectedEmpIds.has(e.id)) : employees.filter(e => { if(bulkFilterType==='all') return true; if(bulkFilterType==='title' && e.title.includes(String(bulkFilterValue))) return true; if(bulkFilterType==='salary' && e.baseSalary===Number(bulkFilterValue)) return true; return false; });
                for(let emp of targets) { if (emp.baseSalary !== target) { c++; await saveEmp({...emp, baseSalary: target, lastRaiseDate: today}); } } 
                setIsBulkModalOpen(false); setSelectedEmpIds(new Set()); alert(`æ›´æ–° ${c} äºº`); 
            };
            const handleExportPaymentList = () => { const exportData = fullPayrollListFlat.map((item, index) => ({ 'åºè™Ÿ': index+1, 'éƒ¨é–€': item.department, 'å“¡å·¥ç·¨è™Ÿ': item.empId, 'å§“å': item.name, 'è·ç¨±': item.title, 'åº•è–ª': item.baseSalary, 'å¯¦ç™¼': item.netPay })); const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "è–ªè³‡å–®"); XLSX.writeFile(wb, "è–ªè³‡å–®.xlsx"); };

            return (
                <div className="min-h-screen pb-24 md:pb-10 bg-gray-50">
                    <nav className="bg-slate-800 text-white shadow-lg print-hidden sticky top-0 z-40 hidden md:block">
                        <div className="max-w-7xl mx-auto px-4 flex justify-between h-16 items-center">
                            <div className="flex items-center space-x-2"><Icons.Calculator className="w-6 h-6 text-yellow-400"/><span className="font-bold text-xl">è–ªè³‡ç®¡ç†ç³»çµ± V36.5</span></div>
                            <div className="flex space-x-2">
                                {isOffline && <span className="offline-badge mr-2 animate-pulse">âš ï¸ é›¢ç·šæ¨¡å¼ (é…é¡é¡æ»¿)</span>}
                                {user && !isOffline && <span className="flex items-center text-xs text-green-400 mr-4"><Icons.Cloud className="w-3 h-3 mr-1"/> é›²ç«¯åŒæ­¥</span>}
                                <button onClick={()=>setActiveTab('employees')} className={`px-3 py-1 rounded ${activeTab==='employees'?'bg-yellow-500 text-black':'hover:bg-slate-700'}`}>å“¡å·¥è¨­å®š</button>
                                <button onClick={()=>setActiveTab('input')} className={`px-3 py-1 rounded ${activeTab==='input'?'bg-yellow-500 text-black':'hover:bg-slate-700'}`}>çµç®—</button>
                                <button onClick={()=>setActiveTab('print')} className={`px-3 py-1 rounded ${activeTab==='print'?'bg-yellow-500 text-black':'hover:bg-slate-700'}`}>å ±è¡¨åˆ—å°</button>
                            </div>
                        </div>
                    </nav>
                    <div className="md:hidden bg-slate-800 text-white p-4 sticky top-0 z-40 flex justify-between items-center print-hidden"><span className="font-bold text-lg flex items-center">è–ªè³‡ç®¡ç† {user && <Icons.Cloud className="w-3 h-3 ml-2 text-green-400"/>}</span><input type="month" value={currentPeriod} onChange={e=>setCurrentPeriod(e.target.value)} className="text-black text-sm rounded px-2 py-1"/></div>
                    <main className="max-w-7xl mx-auto p-4 md:p-8 print-block print:p-0 print:max-w-none">
                        {activeTab === 'employees' && (
                            <div className="space-y-4 animate-fade-in print-hidden">
                                <div className="flex justify-between items-center"><h2 className="text-xl font-bold text-gray-800 hidden md:block">å“¡å·¥è³‡æ–™</h2><div className="flex space-x-2 w-full md:w-auto"><button onClick={()=>{setEditingEmp(null);setIsEmpModalOpen(true)}} className="flex-1 md:flex-none flex items-center justify-center bg-blue-600 text-white px-4 py-2 rounded shadow"><Icons.Plus className="w-4 h-4 mr-1"/> æ–°å¢</button><button onClick={()=>setIsBulkModalOpen(true)} className="flex-1 md:flex-none bg-orange-100 text-orange-700 px-4 py-2 rounded border border-orange-200">èª¿è–ª</button></div></div>
                                <div className="hidden md:block bg-white rounded-xl shadow overflow-hidden"><table className="min-w-full text-sm"><thead className="bg-slate-50 text-left"><tr><th className="p-3 checkbox-cell"><input type="checkbox" className="checkbox-input" checked={selectedEmpIds.size === sortedEmployees.length && sortedEmployees.length > 0} onChange={toggleSelectAll}/></th><th className="p-3">éƒ¨é–€</th><th className="p-3">ç·¨è™Ÿ</th><th className="p-3">å§“å</th><th className="p-3">è·ä½</th><th className="p-3">åº•è–ª</th><th className="p-3">èª¿è–ªæ—¥</th><th className="p-3">æ“ä½œ</th></tr></thead><tbody>{sortedEmployees.map(e => (<tr key={e.id} className="border-b hover:bg-slate-50"><td className="p-3 checkbox-cell"><input type="checkbox" className="checkbox-input" checked={selectedEmpIds.has(e.id)} onChange={()=>toggleSelect(e.id)}/></td><td className="p-3">{e.department}</td><td className="p-3">{e.empId}</td><td className="p-3 font-bold">{e.name}</td><td className="p-3">{e.title}</td><td className="p-3 font-mono">${formatNumber(e.baseSalary)}</td><td className="p-3 text-xs text-gray-500">{e.lastRaiseDate}</td><td className="p-3 space-x-2"><button onClick={()=>{setEditingEmp(e);setIsEmpModalOpen(true)}} className="text-blue-600">ç·¨è¼¯</button><button onClick={()=>deleteEmployee(e.id)} className="text-red-600">åˆªé™¤</button></td></tr>))}</tbody></table></div>
                                <div className="grid grid-cols-1 gap-4 md:hidden"><div className="bg-white p-3 rounded shadow flex justify-between items-center"><span className="font-bold text-gray-600">å…¨é¸/å–æ¶ˆå…¨é¸</span><input type="checkbox" className="w-6 h-6" checked={selectedEmpIds.size === sortedEmployees.length && sortedEmployees.length > 0} onChange={toggleSelectAll}/></div>{sortedEmployees.map(e => (<div key={e.id} className={`bg-white p-4 rounded-lg shadow flex justify-between items-center border-l-4 ${selectedEmpIds.has(e.id) ? 'border-orange-500 bg-orange-50' : 'border-blue-500'}`}><div className="flex items-center"><input type="checkbox" className="w-6 h-6 mr-4" checked={selectedEmpIds.has(e.id)} onChange={()=>toggleSelect(e.id)}/><div><div className="font-bold text-lg">{e.name} <span className="text-sm text-gray-500">({e.empId})</span></div><div className="text-sm text-gray-600">{e.department} | {e.title}</div><div className="text-blue-600 font-bold mt-1">${formatNumber(e.baseSalary)}</div></div></div><div className="flex space-x-3"><button onClick={()=>{setEditingEmp(e);setIsEmpModalOpen(true)}}><Icons.Edit className="w-6 h-6 text-gray-400"/></button><button onClick={()=>deleteEmployee(e.id)}><Icons.Trash2 className="w-6 h-6 text-red-400"/></button></div></div>))}</div>
                            </div>
                        )}
                        {activeTab === 'input' && (
                            <div className="space-y-4 animate-fade-in print-hidden">
                                <div className="bg-white p-4 rounded-lg shadow text-xs mb-4">
                                    <h3 className="font-bold text-lg text-gray-700 border-b pb-1 mb-2">ğŸ’° çµç®—å…¬å¼èªªæ˜ (V36.5)</h3>
                                    <ul className="list-disc list-inside space-y-1 text-gray-600">
                                        <li>**æ™‚è–ªè¨ˆç®—**ï¼š`æ™‚è–ª = åº•è–ª / 240` (å››æ¨äº”å…¥)ã€‚</li>
                                        <li>**åŠ ç­è²»**ï¼š`åŠ ç­è²» = åŠ ç­æ™‚æ•¸ Ã— æ™‚è–ª Ã— å€ç‡`ã€‚</li>
                                        <li>**é²åˆ°æ‰£æ¬¾ (è‡ªå‹•)**ï¼š
                                            <ul className="list-circle list-inside ml-4">
                                                <li>`é²åˆ°æ™‚æ•¸ = Max(0, (æ‡‰å‡ºå‹¤æ™‚æ•¸ - å¯¦éš›å‡ºå‹¤æ™‚æ•¸))`</li>
                                                <li>`é²åˆ°æ‰£æ¬¾ = é²åˆ°æ™‚æ•¸ Ã— æ™‚è–ª Ã— 1.0` (å…¨é¡æ‰£è–ª)ã€‚</li>
                                            </ul>
                                        </li>
                                        <li>**è«‹å‡æ‰£æ¬¾**ï¼š
                                            <ul className="list-circle list-inside ml-4">
                                                <li>`ç—…å‡æ‰£æ¬¾ = ç—…å‡æ™‚æ•¸ (å‚™è¨»è‡ªå‹•æå–) Ã— æ™‚è–ª Ã— 0.5`</li>
                                                <li>`äº‹å‡æ‰£æ¬¾ = äº‹å‡æ™‚æ•¸ (å‚™è¨»è‡ªå‹•æå–) Ã— æ™‚è–ª Ã— 1.0`</li>
                                            </ul>
                                        </li>
                                        <li>**å‡åˆ¥è‡ªå‹•æå–**ï¼šç³»çµ±æœƒå¾ Excel çš„ã€Œå‚™è¨»ã€æ¬„ä½ä¸­ï¼Œè‡ªå‹•è­˜åˆ¥ä¸¦ä»£å…¥ã€Œç‰¹ä¼‘ã€ã€ã€Œç—…å‡ã€ã€ã€Œäº‹å‡ã€ã€ã€Œå–ªå‡ã€æ™‚æ•¸ã€‚</li>
                                    </ul>
                                </div>
                                <div className="hidden md:flex justify-between mb-4"><div className="flex items-center space-x-4"><input type="month" value={currentPeriod} onChange={e=>setCurrentPeriod(e.target.value)} className="border rounded px-2 py-1"/>{isLocked && <span className="text-red-600 font-bold bg-red-50 px-2 py-1 rounded">å·²çµæ¡ˆ</span>}<button onClick={toggleLock} className="text-sm underline text-gray-500">{isLocked ? 'è§£é–' : 'é–å®š'}</button></div><button onClick={()=>setIsImportModalOpen(true)} className={`px-4 py-2 bg-emerald-600 text-white rounded ${isLocked?'opacity-50':''}`} disabled={isLocked}>åŒ¯å…¥ Excel</button></div>
                                <div className="md:hidden flex justify-between items-center mb-2"><span className="text-gray-500 text-sm">{isLocked ? 'ğŸ”’ æœ¬æœˆå·²çµæ¡ˆ' : 'ğŸŸ¢ ç·¨è¼¯ä¸­'}</span><button onClick={toggleLock} className="text-xs bg-gray-200 px-2 py-1 rounded">{isLocked ? 'è§£é–' : 'çµæ¡ˆ'}</button></div>
                                {!isLocked && (<button onClick={()=>setIsImportModalOpen(true)} className="md:hidden w-full py-3 bg-emerald-100 text-emerald-700 font-bold rounded-lg border border-emerald-200 mb-4 flex items-center justify-center"><Icons.FileSpreadsheet className="w-5 h-5 mr-2"/> åŒ¯å…¥ Excel</button>)}
                                
                                <div className="hidden md:block bg-white rounded-xl shadow overflow-x-auto">
                                    <table className="min-w-full text-xs whitespace-nowrap">
                                        <thead className="bg-slate-100">
                                            <tr>
                                                {/* V36.4: ä¾ç…§æŒ‡å®šé †åºé‡æ–°æ’åˆ—æ¬„ä½ */}
                                                <th className="p-2 sticky left-0 bg-slate-100 z-10">å“¡å·¥</th>
                                                <th className="p-2">æœ¬è–ª</th>
                                                <th className="p-2 text-blue-800 bg-blue-50">æ‡‰ä¸Šç­</th> {/* V36.4 æ–°å¢ */}
                                                <th className="p-2">å¯¦å·¥</th>
                                                <th className="p-2 bg-blue-50">å¹³(1.34)</th>
                                                <th className="p-2 bg-blue-50">å¹³(1.67)</th>
                                                <th className="p-2 bg-purple-50">ä¾‹(1.34)</th>
                                                <th className="p-2 bg-purple-50">ä¾‹(1.67)</th>
                                                <th className="p-2">ææ—©</th>
                                                <th className="p-2">æœªä¼‘</th>
                                                <th className="p-2">ä¼‘åŠ </th>
                                                <th className="p-2 text-green-700">åˆé¤</th>
                                                <th className="p-2 text-green-700">æ¥­å‹™</th>
                                                <th className="p-2 text-green-700">å…¶å®ƒ</th>
                                                <th className="p-2 text-red-700 bg-red-100">ç—…å‡</th>
                                                <th className="p-2 text-red-800 bg-red-100">äº‹å‡</th>
                                                {/* V36.5 æ–°å¢ç‰¹ä¼‘æ¬„ä½ */}
                                                <th className="p-2 text-blue-600 bg-blue-100">ç‰¹ä¼‘</th>
                                                <th className="p-2 text-red-900 bg-red-50">æ› è·</th>
                                                <th className="p-2 text-orange-700">å‹å¥</th>
                                                <th className="p-2 sticky right-0 bg-slate-100 z-10">å¯¦ç™¼</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {fullPayrollListFlat.map(item => (
                                                <tr key={item.id} className="border-b hover:bg-gray-50">
                                                    <td className="p-2 sticky left-0 bg-white font-bold z-10">{item.name}</td>
                                                    <td className="p-1 font-mono">${formatNumber(item.baseSalary)}</td> {/* V36.4: æœ¬è–ªæ¬„ä½ */}
                                                    <td className="p-1 bg-blue-50"><input disabled={isLocked} className="w-14 border text-blue-800 font-bold" value={item.expectedWorkHoursVal > 0 ? hoursToTimeStr(item.expectedHoursVal) : (item.expectedWorkDays ? item.expectedWorkDays*8 + ":00" : "00:00")} onChange={e=>updateVal(item.empId,'expectedWorkHours',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'expectedWorkHours',e.target.value)}/></td> {/* V36.4: æ‡‰ä¸Šç­æ¬„ä½ */}
                                                    <td className="p-1"><input disabled={isLocked} className="w-14 border" value={item.actualWorkHours} onChange={e=>updateVal(item.empId,'actualWorkHours',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'actualWorkHours',e.target.value)}/></td>
                                                    <td className="p-1 bg-blue-50"><input disabled={isLocked} className="w-12 border" value={item.wt034} onChange={e=>updateVal(item.empId,'wt034',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'wt034',e.target.value)}/></td>
                                                    <td className="p-1 bg-blue-50"><input disabled={isLocked} className="w-12 border" value={item.wt067} onChange={e=>updateVal(item.empId,'wt067',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'wt067',e.target.value)}/></td>
                                                    <td className="p-1 bg-purple-50"><input disabled={isLocked} className="w-12 border" value={item.hd134} onChange={e=>updateVal(item.empId,'hd134',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'hd134',e.target.value)}/></td>
                                                    <td className="p-1 bg-purple-50"><input disabled={isLocked} className="w-12 border" value={item.hd167} onChange={e=>updateVal(item.empId,'hd167',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'hd167',e.target.value)}/></td>
                                                    <td className="p-1"><input disabled={isLocked} className="w-12 border" value={item.earlyShift} onChange={e=>updateVal(item.empId,'earlyShift',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'earlyShift',e.target.value)}/></td>
                                                    <td className="p-1"><input disabled={isLocked} className="w-12 border" value={item.noLunch} onChange={e=>updateVal(item.empId,'noLunch',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'noLunch',e.target.value)}/></td>
                                                    <td className="p-1"><input disabled={isLocked} className="w-12 border" value={item.holidayOT} onChange={e=>updateVal(item.empId,'holidayOT',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'holidayOT',e.target.value)}/></td>
                                                    <td className="p-1"><input type="number" disabled={isLocked} className="w-14 border" value={item.lunchAllowance} onChange={e=>updateVal(item.empId,'lunchAllowance',e.target.value)}/></td>
                                                    <td className="p-1 bg-green-50"><input type="number" disabled={isLocked} className="w-14 border font-bold text-green-700" value={item.businessBonus} onChange={e=>updateVal(item.empId,'businessBonus',e.target.value)}/></td>
                                                    <td className="p-1 bg-green-50"><input type="number" disabled={isLocked} className="w-14 border font-bold text-green-700" value={item.otherBonus} onChange={e=>updateVal(item.empId,'otherBonus',e.target.value)}/></td>
                                                    <td className="p-1 bg-red-100"><input disabled={isLocked} className="w-12 border input-locked" value={item.sickLeave} /></td>
                                                    <td className="p-1 bg-red-100"><input disabled={isLocked} className="w-12 border input-locked" value={item.personalLeave} /></td>
                                                    {/* V36.5 æ–°å¢ç‰¹ä¼‘æ¬„ä½ */}
                                                    <td className="p-1 bg-blue-100"><input disabled={isLocked} className="w-12 border input-locked" value={item.annualLeave} /></td>
                                                    <td className="p-1 bg-red-50"><input disabled={isLocked} className="w-12 border text-red-800 font-bold" value={item.absentTime || "00:00"} onChange={e=>updateVal(item.empId,'absentTime',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'absentTime',e.target.value)}/></td>
                                                    <td className="p-1"><input type="number" disabled={isLocked} className="w-14 border" value={item.deduction} onChange={e=>updateVal(item.empId,'deduction',e.target.value)}/></td>
                                                    <td className="p-2 sticky right-0 bg-white font-bold text-blue-700 z-10">${formatNumber(item.netPay)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                <div className="grid grid-cols-1 gap-3 md:hidden">{fullPayrollListFlat.map(item => (<div key={item.id} className="bg-white p-4 rounded-lg shadow active:bg-blue-50 transition border border-gray-100" onClick={() => !isLocked && setMobileEditItem(item)}><div className="flex justify-between items-center"><div><div className="font-bold text-lg">{item.name}</div><div className="text-xs text-gray-500">å¯¦ç™¼è–ªè³‡</div></div><div className="text-2xl font-bold text-blue-600">${formatNumber(item.netPay)}</div></div><div className="mt-3 pt-3 border-t flex justify-between text-xs text-gray-500"><span>åŠ é …: ${formatNumber(item.totalAdditions)}</span><span>æ‰£é …: ${formatNumber(item.finalDeduction)}</span><span>å·¥æ™‚: {item.actualWorkHours}</span></div>{!isLocked && <div className="text-center text-xs text-blue-400 mt-2">é»æ“Šç·¨è¼¯æ˜ç´°</div>}</div>))}</div>
                            </div>
                        )}

                        {activeTab === 'print' && (
                            <div className="print-block space-y-4 screen-preview-container">
                                <div className="bg-white p-4 rounded shadow print-hidden col-span-full">
                                    <h2 className="text-lg font-bold mb-2">å ±è¡¨é è¦½ (é›»è…¦ç‰ˆï¼š2æ¬„å¡ç‰‡)</h2>
                                    <div className="flex space-x-2"><button onClick={handleExportPaymentList} className="flex-1 py-3 bg-emerald-600 text-white rounded font-bold flex items-center justify-center"><Icons.Download className="w-5 h-5 mr-2"/> åŒ¯å‡º Excel</button><button onClick={()=>window.print()} className="flex-1 py-3 bg-slate-800 text-white rounded font-bold">åˆ—å°è–ªè³‡å–®</button></div>
                                </div>
                                
                                <div id="print-container-root">
                                    {chunkedPayrollList.map((chunk, pageIndex) => (
                                        <div key={pageIndex} className="print-page">
                                            {chunk.map(item => (
                                                <div key={item.id} className="payroll-slip-style">
                                                    <div className="slip-title print-title">{getTitle(currentPeriod)} è–ªè³‡å–®</div>
                                                    <div className="emp-info-row">
                                                        <span className="emp-name">{item.name} <span className="emp-id">({item.empId})</span></span>
                                                        <span className="emp-dept">{item.department}</span>
                                                    </div>
                                                    <div className="body-grid">
                                                        <div>
                                                            <div className="section-title">æ‡‰ç™¼é …ç›® (+)</div>
                                                            {(safeNum(item.baseSalary) > 0) && <div className="item-row"><span className="item-label">åº•è–ª</span><span className="item-value">${formatNumber(item.baseSalary)}</span></div>}
                                                            {item.payWt034 > 0 && <div className="item-row"><span className="item-label">å¹³æ—¥åŠ ç­(1.34)</span><span className="item-value">${formatNumber(item.payWt034)}</span></div>}
                                                            {item.payWt067 > 0 && <div className="item-row"><span className="item-label">å¹³æ—¥åŠ ç­(1.67)</span><span className="item-value">${formatNumber(item.payWt067)}</span></div>}
                                                            {item.payHd134 > 0 && <div className="item-row"><span className="item-label">ä¾‹å‡åŠ ç­(1.34)</span><span className="item-value">${formatNumber(item.payHd134)}</span></div>}
                                                            {item.payHd167 > 0 && <div className="item-row"><span className="item-label">ä¾‹å‡åŠ ç­(1.67)</span><span className="item-value">${formatNumber(item.payHd167)}</span></div>}
                                                            {item.payEarly > 0 && <div className="item-row"><span className="item-label">ææ—©ä¸Šç­</span><span className="item-value">${formatNumber(item.payEarly)}</span></div>}
                                                            {item.payNoLunch > 0 && <div className="item-row"><span className="item-label">ä¸­åˆæœªä¼‘</span><span className="item-value">${formatNumber(item.payNoLunch)}</span></div>}
                                                            {item.payHolidayOT > 0 && <div className="item-row"><span className="item-label">ä¼‘å‡åŠ ç­</span><span className="item-value">${formatNumber(item.payHolidayOT)}</span></div>}
                                                            {item.lunchAllowance > 0 && <div className="item-row"><span className="item-label">åˆé¤æ´¥è²¼</span><span className="item-value">${formatNumber(item.lunchAllowance)}</span></div>}
                                                            {item.businessBonus > 0 && <div className="item-row"><span className="item-label">æ¥­å‹™åŠ çµ¦</span><span className="item-value">${formatNumber(item.businessBonus)}</span></div>}
                                                            {item.otherBonus > 0 && <div className="item-row"><span className="item-label">å…¶å®ƒåŠ é …</span><span className="item-value">${formatNumber(item.otherBonus)}</span></div>}
                                                            <div className="subtotal-row"><span>æ‡‰ç™¼åˆè¨ˆ</span><span>${formatNumber(item.grossPay)}</span></div>
                                                        </div>
                                                        <div className="body-divider"></div>
                                                        <div>
                                                            <div className="section-title">æ‡‰æ‰£é …ç›® (-)</div>
                                                            {(safeNum(item.insuranceFee) > 0) && <div className="item-row"><span className="item-label">å‹å¥ä¿è²»</span><span className="item-value text-red-700">${formatNumber(item.insuranceFee)}</span></div>}
                                                            
                                                            {item.dedAbsent > 0 && <div className="item-row"><span className="item-label">æ› è·æ‰£æ¬¾</span><span className="item-value text-red-700">${formatNumber(item.dedAbsent)}</span></div>}
                                                            {item.dedSick > 0 && <div className="item-row"><span className="item-label">ç—…å‡æ‰£æ¬¾</span><span className="item-value text-red-700">${formatNumber(item.dedSick)}</span></div>}
                                                            {item.dedPersonal > 0 && <div className="item-row"><span className="item-label">äº‹å‡æ‰£æ¬¾</span><span className="item-value text-red-700">${formatNumber(item.dedPersonal)}</span></div>}
                                                            
                                                            {/* æ–°å¢ï¼šé²åˆ°èˆ‡æ› è·æ‰£æ¬¾é¡¯ç¤º */}
                                                            {item.dedLate > 0 && <div className="item-row"><span className="item-label">é²åˆ° ({item.calcLateHoursStr})</span><span className="item-value text-red-700">${formatNumber(item.dedLate)}</span></div>}
                                                            {item.dedAbsent > 0 && <div className="item-row"><span className="item-label">æ› è· ({item.absentTime})</span><span className="item-value text-red-700">${formatNumber(item.dedAbsent)}</span></div>}

                                                            <div className="subtotal-row" style={{color:'#dc2626'}}><span>æ‡‰æ‰£åˆè¨ˆ</span><span>${formatNumber(item.finalDeduction)}</span></div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* ä¿®æ­£ï¼šFooter ä½ˆå±€ */}
                                                    <div className="footer">
                                                        <div className="footer-main">
                                                            <div className="footer-left">
                                                                <p style={{fontWeight:'bold', marginBottom:'2px'}}>æ„Ÿè¬æ‚¨æœ¬æœˆçš„è¾›å‹ï¼</p>
                                                                å·¥æ™‚:{item.actualWorkHours} / æ‡‰å‹¤:{item.expectedHoursVal > 0 ? hoursToTimeStr(item.expectedHoursVal) : '00:00'}H<br/>
                                                                {item.note && <div style={{marginTop:'2px', fontSize:'11px'}}>å‚™è¨»:{item.note}</div>}
                                                            </div>
                                                            <div className="footer-right">
                                                                <span className="net-pay-label">å¯¦ç™¼</span>
                                                                <span className="net-pay-value">${formatNumber(item.netPay)}</span>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* ä¿®æ­£ï¼šå‡åˆ¥é¡¯ç¤ºåœ¨æœ€åº•éƒ¨ */}
                                                        <div className="footer-leaves">
                                                            {(timeStrToHours(item.annualLeave) > 0) && <span style={{marginRight:'8px'}}>ç‰¹ä¼‘:{item.annualLeave}</span>}
                                                            {(timeStrToHours(item.bereavementLeave) > 0) && <span style={{marginRight:'8px'}}>å–ªå‡:{item.bereavementLeave}</span>}
                                                            {(timeStrToHours(item.sickLeave) > 0) && <span style={{marginRight:'8px'}}>ç—…å‡:{item.sickLeave}</span>}
                                                            {(timeStrToHours(item.personalLeave) > 0) && <span style={{marginRight:'8px'}}>äº‹å‡:{item.personalLeave}</span>}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {mobileEditItem && <div className="fixed inset-0 bg-white z-50 overflow-y-auto pb-safe print-hidden"><div className="sticky top-0 bg-slate-800 text-white p-4 flex justify-between items-center shadow"><div><div className="font-bold text-lg">{mobileEditItem.name}</div><div className="text-xs opacity-75">{currentPeriod} ç·¨è¼¯</div></div><button onClick={() => setMobileEditItem(null)} className="px-4 py-1 bg-slate-600 rounded">å®Œæˆ</button></div><div className="p-4 space-y-6"><div className="space-y-3"><h3 className="font-bold text-gray-500 border-b pb-1">å·¥æ™‚ç´€éŒ„</h3><div className="grid grid-cols-2 gap-4"><label className="block text-sm">æ‡‰ä¸Šç­å¤©æ•¸ <input type="number" className="w-full border rounded p-2 mt-1 bg-gray-50" value={mobileEditItem.expectedWorkDays} onChange={e=>updateVal(mobileEditItem.empId, 'expectedWorkDays', e.target.value)}/></label><label className="block text-sm">å¯¦éš›æ™‚æ•¸ <input type="text" className="w-full border rounded p-2 mt-1 bg-gray-50" value={mobileEditItem.actualWorkHours} onChange={e=>updateVal(mobileEditItem.empId, 'actualWorkHours', e.target.value)} onBlur={e=>handleTimeBlur(mobileEditItem.empId, 'actualWorkHours', e.target.value)}/></label></div></div><div className="space-y-3"><h3 className="font-bold text-blue-600 border-b pb-1">åŠ ç­æ™‚æ•¸</h3><div className="grid grid-cols-2 gap-4"><label className="block text-sm">å¹³åŠ  1.34 <input type="text" className="w-full border rounded p-2 mt-1" value={mobileEditItem.wt034} onChange={e=>updateVal(mobileEditItem.empId, 'wt034', e.target.value)} onBlur={e=>handleTimeBlur(mobileEditItem.empId, 'wt034', e.target.value)}/></label><label className="block text-sm">å¹³åŠ  1.67 <input type="text" className="w-full border rounded p-2 mt-1" value={mobileEditItem.wt067} onChange={e=>updateVal(mobileEditItem.empId, 'wt067', e.target.value)} onBlur={e=>handleTimeBlur(mobileEditItem.empId, 'wt067', e.target.value)}/></label></div></div><div className="h-20"></div></div></div>}
                        {/* Modals */}
                        {isImportModalOpen && <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden"><div className="bg-white p-6 rounded shadow-xl w-full max-w-lg"><h3 className="font-bold text-lg mb-4">åŒ¯å…¥ Excel</h3><input type="file" ref={fileInputRef} accept=".xlsx,.csv" onChange={handleExcel} className="border p-2 w-full"/><button onClick={()=>setIsImportModalOpen(false)} className="mt-4 px-4 py-2 bg-gray-200 rounded">é—œé–‰</button></div></div>}
                        
                        {isEmpModalOpen && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden">
                                <div className="bg-white p-6 rounded shadow-xl w-full max-w-sm">
                                    <h3 className="font-bold text-lg mb-4">ç·¨è¼¯å“¡å·¥</h3>
                                    <form onSubmit={handleSaveEmployee} className="space-y-3">
                                        <input name="empId" defaultValue={editingEmp?.empId} placeholder="ID" className="border p-2 w-full"/>
                                        <input name="name" defaultValue={editingEmp?.name} placeholder="å§“å" className="border p-2 w-full"/>
                                        <input name="title" defaultValue={editingEmp?.title} placeholder="è·ä½" className="border p-2 w-full"/>
                                        <input name="department" defaultValue={editingEmp?.department} placeholder="éƒ¨é–€" className="border p-2 w-full"/>
                                        <input name="baseSalary" type="number" defaultValue={editingEmp?.baseSalary} placeholder="åº•è–ª" className="border p-2 w-full"/>
                                        
                                        {/* V31: æ–°å¢ä¸Šæ¬¡èª¿è–ªæ—¥æœŸæ¬„ä½ */}
                                        <label className="block text-sm text-gray-500">ä¸Šæ¬¡èª¿è–ªæ—¥æœŸ</label>
                                        <input name="lastRaiseDate" type="date" defaultValue={editingEmp?.lastRaiseDate} className="border p-2 w-full"/>
                                        
                                        <div className="flex justify-end gap-2 mt-4">
                                            <button type="button" onClick={()=>setIsEmpModalOpen(false)} className="px-3 py-1 border rounded">å–æ¶ˆ</button><button className="px-3 py-1 bg-blue-600 text-white rounded">å„²å­˜</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}
                        
                        {isBulkModalOpen && <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden"><div className="bg-white p-6 rounded shadow-xl w-full max-w-sm"><h3 className="font-bold text-lg mb-4">æ‰¹é‡èª¿è–ª</h3><form onSubmit={handleBulkSubmit} className="space-y-3"><input type="number" value={bulkTargetSalary} onChange={e=>setBulkTargetSalary(e.target.value)} className="border p-2 w-full" placeholder="æ–°åº•è–ª"/><div className="flex justify-end gap-2"><button type="button" onClick={()=>setIsBulkModalOpen(false)} className="px-3 py-1 border rounded">å–æ¶ˆ</button><button className="px-3 py-1 bg-orange-600 text-white rounded">åŸ·è¡Œ</button></div></form></div></div>}
                    </main>
                    <MobileNav activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PayrollApp />);
    </script>
</body>
</html>