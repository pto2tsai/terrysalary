<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>薪資管理系統 (V38.3 - UI優化版)</title>
    
    <!-- 1. 引入樣式與核心庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- 2. 引入 Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken, 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            deleteDoc, 
            onSnapshot,
            query,
            orderBy
        };
    </script>

    <style>
        /* 基礎樣式 */
        body { 
            background-color: #525252; 
            color: #1f2937; 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }
        input, select, button { touch-action: manipulation; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* 隱藏 number input 的上下箭頭 */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* --- 薪資單卡片樣式 (共用) --- */
        .payroll-slip-style {
            background: white;
            border: 3px double #000;
            padding: 10px 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            color: #000;
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        .slip-title { 
            font-size: 30px !important; 
            font-weight: 900 !important; 
            text-align: center; 
            border-bottom: 3px solid #000; 
            margin-bottom: 5px; 
            padding-bottom: 2px; 
            letter-spacing: 2px; 
            line-height: 1.1;
        }
        
        .emp-info-row {
            display: flex; 
            justify-content: space-between; 
            align-items: baseline; 
            border-bottom: 1px dashed #000; 
            padding-bottom: 4px; 
            margin-bottom: 8px;
        }
        .emp-name { font-size: 24px !important; font-weight: 900 !important; }
        .emp-id { font-size: 14px !important; font-weight: 600; margin-left: 6px; }
        .emp-dept { font-size: 16px !important; font-weight: 800; }

        /* 核心二欄式佈局 */
        .body-grid { 
            display: grid; 
            grid-template-columns: 1fr 1px 1fr; 
            gap: 10px; 
            flex-grow: 1; 
        }
        .body-divider { background-color: #000; width: 1px; height: 100%; }

        .section-title { 
            font-size: 15px !important; 
            font-weight: 900 !important; 
            text-decoration: none; 
            margin-bottom: 4px; 
            text-align: center;
        }

        .item-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            line-height: 1.3; 
            margin-bottom: 1px;
        }
        /* 字體大小設定 */
        .item-label { font-size: 14px !important; font-weight: 700 !important; text-align: left; }
        .item-value { font-size: 16px !important; font-weight: 800 !important; font-family: Consolas, monospace; text-align: right; }
        
        .subtotal-row {
            border-top: 2px solid #000;
            margin-top: 4px;
            padding-top: 2px;
            display: flex;
            justify-content: space-between;
            font-weight: 900;
            font-size: 15px !important;
        }

        .footer {
            margin-top: auto;
            border-top: 3px double #000;
            padding-top: 4px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .footer-main { display: flex; justify-content: space-between; alignItems: flex-end; width: 100%; }
        .net-pay-label { font-size: 18px !important; font-weight: 800; margin-right: 5px; }
        .net-pay-value { 
            font-size: 32px !important; 
            font-weight: 900; 
            font-family: Consolas, monospace; 
            border-bottom: 4px double #000; 
            line-height: 1;
        }
        
        .footer-leaves { 
            margin-top: 4px; 
            padding-top: 4px; 
            border-top: 1px dotted #999; 
            font-size: 12px !important; 
            font-weight: 600; 
            color: #333; 
        }
        
        .footer-hours-info {
            font-size: 12px !important; 
            font-weight: 600; 
            color: #333; 
            line-height: 1.3;
        }

        @media screen {
            #print-container-root {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 30px;
                padding: 20px;
            }
            .print-header-block {
                width: 210mm;
                margin: 0 auto;
            }
            .print-page { 
                width: 210mm; 
                height: 296mm; 
                background: white; 
                padding: 5mm; 
                box-sizing: border-box; 
                display: grid; 
                grid-template-columns: 1fr 1fr; 
                grid-template-rows: 1fr 1fr; 
                gap: 5mm; 
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); 
            }
            @media (max-width: 1023px) {
                #print-container-root {
                     align-items: stretch;
                     padding: 10px;
                     gap: 10px;
                }
                .print-header-block {
                    width: 100%;
                }
                .print-page { 
                    width: 100%; 
                    height: auto; 
                    display: grid; 
                    grid-template-columns: 1fr; 
                    gap: 15px; 
                    box-shadow: none; 
                    background: transparent; 
                    padding: 0; 
                }
                .payroll-slip-style { height: auto !important; min-height: 400px; border: 1px solid #ccc; }
            }
        }

        /* 列印設定：A4 2x2 佈局與邊界設定 */
        @media print {
            @page { 
                size: A4; 
                margin: 1.2cm 0.8cm 1.2cm 0.8cm; 
            }
            
            html, body { 
                margin: 0 !important; 
                padding: 0 !important; 
            }
            body { 
                background-color: white; 
                box-sizing: border-box; 
            }
            body * { visibility: hidden; }
            #print-container-root, #print-container-root * { visibility: visible; }
            #print-container-root { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                page-break-after: avoid;
                break-after: avoid;
                page-break-inside: avoid !important; 
            }
            .print-page { 
                width: 193mm; 
                height: 272mm; 
                margin: 0 auto; 
                padding: 0; 
                box-sizing: border-box; 
                display: grid !important; 
                grid-template-columns: 1fr 1fr !important; 
                grid-template-rows: 1fr 1fr !important; 
                gap: 5mm !important; 
                page-break-after: auto !important; 
                break-after: auto !important;
                page-break-inside: avoid !important;
            }
            .payroll-slip-style { 
                width: 100% !important; 
                height: 100% !important; 
                box-shadow: none !important; 
                margin: 0 !important; 
                border: 3px double #000 !important; 
                page-break-inside: avoid;
            }
            nav, .mobile-nav, button, .no-print, #loading-screen, #error-display { display: none !important; }
        }
        
        .input-locked { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; border-color: #e5e7eb; }
        .checkbox-cell { width: 40px; text-align: center; }
        .checkbox-input { width: 18px; height: 18px; cursor: pointer; }
        .offline-badge { background-color: #ef4444; color: white; font-size: 12px; padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; }
        
        /* Toast 通知樣式 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast-success { background: linear-gradient(135deg, #10b981, #059669); }
        .toast-error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .toast-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .toast-info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        
        /* 刪除淡出動畫 */
        .fade-out { animation: rowFadeOut 0.3s ease forwards; }
        @keyframes rowFadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        
        /* 輸入欄位驗證樣式 */
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .input-warning { border-color: #f59e0b !important; background-color: #fffbeb !important; }
    </style>
</head>
<body class="pb-20 md:pb-0">

    <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500">正在連線至雲端資料庫...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef, useCallback } = React;

        // 0. Firebase Config
        const USER_FIREBASE_CONFIG = {
          apiKey: "AIzaSyDvu-VONOJoj251pMPMXRfT_L4uVDJS4Q8",
          authDomain: "terrysalary.firebaseapp.com",
          projectId: "terrysalary",
          storageBucket: "terrysalary.firebasestorage.app",
          messagingSenderId: "556461050986",
          appId: "1:556461050986:web:7a8f13d3d9adb5f77d0e13"
        };

        // ===== 系統配置常數 =====
        const CONFIG = {
            MONTHLY_WORK_HOURS: 240,        // 月工時基準
            DEFAULT_PENSION_RATE: 0.06,     // 預設勞退提撥率
            DEFAULT_LABOR_BASE: 30300,      // 預設勞保投保金額
            OT_RATE_134: 1.34,              // 加班倍率 1.34
            OT_RATE_167: 1.67,              // 加班倍率 1.67
            SICK_LEAVE_RATE: 0.5,           // 病假扣款比例 (半薪)
            PERSONAL_LEAVE_RATE: 1.0,       // 事假扣款比例 (全薪)
            MAX_SALARY: 9999999,            // 最大薪資上限
            MAX_HOURS: 744,                 // 最大月時數 (31天x24小時)
        };

        // ===== 輸入驗證函數 =====
        const Validators = {
            salary: (value) => {
                const num = Number(value);
                if (isNaN(num)) return { valid: false, message: '請輸入有效數字' };
                if (num < 0) return { valid: false, message: '薪資不可為負數' };
                if (num > CONFIG.MAX_SALARY) return { valid: false, message: `薪資超過上限 ${CONFIG.MAX_SALARY.toLocaleString()}` };
                return { valid: true };
            },
            hours: (value) => {
                const hours = timeStrToHours(value);
                if (hours < 0) return { valid: false, message: '時數不可為負數' };
                if (hours > CONFIG.MAX_HOURS) return { valid: false, message: `時數超過上限 ${CONFIG.MAX_HOURS}` };
                return { valid: true };
            },
            required: (value) => {
                if (!value || String(value).trim() === '') return { valid: false, message: '此欄位為必填' };
                return { valid: true };
            },
            empId: (value, existingIds = []) => {
                if (!value) return { valid: false, message: '員工編號為必填' };
                if (existingIds.includes(value)) return { valid: false, message: '員工編號已存在' };
                return { valid: true };
            }
        };

        // ===== Toast 通知元件 =====
        const ToastContext = React.createContext();
        
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            
            const addToast = useCallback((message, type = 'success', duration = 3000) => {
                const id = Date.now() + Math.random();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, duration);
            }, []);
            
            const toast = useMemo(() => ({
                success: (msg) => addToast(msg, 'success'),
                error: (msg) => addToast(msg, 'error'),
                warning: (msg) => addToast(msg, 'warning'),
                info: (msg) => addToast(msg, 'info'),
            }), [addToast]);
            
            return (
                <ToastContext.Provider value={toast}>
                    {children}
                    <div className="toast-container print-hidden">
                        {toasts.map(t => (
                            <div key={t.id} className={`toast toast-${t.type}`}>
                                {t.type === 'success' && '✓'}
                                {t.type === 'error' && '✕'}
                                {t.type === 'warning' && '⚠'}
                                {t.type === 'info' && 'ℹ'}
                                {t.message}
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };
        
        const useToast = () => React.useContext(ToastContext);

        // 1. Icons
        const Icons = {
            Calculator: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/><line x1="16" x2="16" y1="14" y2="18"/></svg>,
            Users: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Printer: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            Plus: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M5 12h14M12 5v14"/></svg>,
            Trash2: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Settings: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Upload: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Clock: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            FileSpreadsheet: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
            RefreshCw: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>,
            Edit: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Download: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Lock: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Cloud: (p)=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
            ChevronRight: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="9 18 15 12 9 6"/></svg>,
            X: (p)=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        };

        // 2. MobileNav
        const MobileNav = ({ activeTab, setActiveTab }) => (
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around py-3 pb-safe shadow-lg z-50 md:hidden no-print">
                <button onClick={() => setActiveTab('employees')} className={`flex flex-col items-center ${activeTab === 'employees' ? 'text-blue-600' : 'text-gray-400'}`}>
                    <Icons.Users className="w-6 h-6" />
                    <span className="text-xs mt-1">員工</span>
                </button>
                <button onClick={() => setActiveTab('input')} className={`flex flex-col items-center ${activeTab === 'input' ? 'text-blue-600' : 'text-gray-400'}`}>
                    <Icons.Calculator className="w-6 h-6" />
                    <span className="text-xs mt-1">結算</span>
                </button>
                <button onClick={() => setActiveTab('print')} className={`flex flex-col items-center ${activeTab === 'print' ? 'text-blue-600' : 'text-gray-400'}`}>
                    <Icons.Printer className="w-6 h-6" />
                    <span className="text-xs mt-1">列印</span>
                </button>
            </div>
        );

        // 3. Global Helper Functions
        function formatNumber(num) {
            if (num === undefined || num === null || num === '') return '0';
            const n = Number(num);
            return isNaN(n) ? "0" : n.toLocaleString();
        }

        function getTitle(period) {
            if (!period) return "";
            const parts = period.split('-');
            if (parts.length < 2) return period;
            return `${parts[0]}年${parts[1]}月`;
        }
        
        function safeNum(val) { const num = Number(val); return isNaN(num) ? 0 : num; }
        function timeStrToHours(str) { if (!str) return 0; const parts = String(str).split(':').map(Number); return (safeNum(parts[0])) + (safeNum(parts[1]))/60; }
        function hoursToTimeStr(hours) { if (!hours && hours !== 0) return "00:00"; const h = Math.floor(hours); const m = Math.round((hours - h) * 60); return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`; }
        
        function formatInputTime(val) {
            if(!val) return "00:00"; 
            val = String(val).trim();
            if (val.includes('.')) { 
                const num = parseFloat(val); 
                const h = Math.floor(num); 
                const m = Math.round((num - h) * 60); 
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; 
            }
            if (!val.includes(':')) { 
                const num = parseInt(val);
                if (!isNaN(num) && num > 24) return `${num}:00`;
                if (val.length <= 2) return `${val.padStart(2,'0')}:00`; 
                if (val.length === 3) return `0${val[0]}:${val.substring(1)}`; 
                if (val.length === 4) return `${val.substring(0,2)}:${val.substring(2)}`; 
            }
            const parts = val.split(':'); 
            return `${String(parseInt(parts[0])||0).padStart(2,'0')}:${String(parseInt(parts[1])||0).padStart(2,'0')}`;
        }
        
        function excelTimeToString(val) { 
            const n = safeNum(val);
            if (typeof val === 'number' && val > 0 && val < 1) { 
                const t = val * 24; 
                const h = Math.floor(t); 
                const m = Math.round((t - h) * 60); 
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; 
            } 
            if (typeof val === 'number' && val >= 1) return hoursToTimeStr(val);
            return formatInputTime(val); 
        }
        
        function parseLeave(note) {
            let sickHours=0, personalHours=0, annualHours=0, bereavementHours=0;
            if (!note) return { sickLeave: "00:00", personalLeave: "00:00", annualLeave: "00:00", bereavementLeave: "00:00" };
            const str = note.toString();
            const regex = /(病假|事假|曠職|扣薪|特休|年假|喪假)\s*(\d+)([:\.](\d+))?/gi;
            let match;
            while ((match = regex.exec(str)) !== null) {
                const type = match[1];
                const hours = parseInt(match[2]) || 0;
                const minutes = parseInt(match[4]) || 0;
                let totalHours = hours;
                if (match[3] && match[3].includes(':')) totalHours = hours + minutes / 60;
                else if (match[3] && match[3].includes('.')) totalHours = hours + minutes / 100;

                if (type.includes("特休") || type.includes("年假")) annualHours += totalHours;
                else if (type.includes("病假")) sickHours += totalHours;
                else if (type.includes("事假") || type.includes("扣薪") || type.includes("曠職")) personalHours += totalHours;
                else if (type.includes("喪假")) bereavementHours += totalHours;
            }
            return { sickLeave: hoursToTimeStr(sickHours), personalLeave: hoursToTimeStr(personalHours), annualLeave: hoursToTimeStr(annualHours), bereavementLeave: hoursToTimeStr(bereavementHours) };
        }

        function chunkArray(array, size) {
            const chunked = [];
            for (let i = 0; i < array.length; i += size) chunked.push(array.slice(i, i + size));
            return chunked;
        }

        function normalizeToTimeStr(val) {
            if (!val) return "00:00";
            const s = String(val).trim();
            if (s === "" || s === "0") return "00:00";
            if (s.includes(":")) {
                const parts = s.split(":");
                const h = parseInt(parts[0]) || 0;
                const m = parseInt(parts[1]) || 0;
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            }
            const num = parseFloat(s);
            if (!isNaN(num)) {
                const h = Math.floor(num);
                const m = Math.round((num - h) * 60);
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            }
            return "00:00";
        }

        // 4. Salary Calculation (V38.0 修正版)
        function calculateSalary(emp, data) {
            if (!emp) return null;
            const d = data || {};
            const hourlyRate = Math.round(safeNum(emp.baseSalary) / CONFIG.MONTHLY_WORK_HOURS * 100) / 100; 
            
            const expectedHoursFromDays = safeNum(d.expectedWorkDays || 0) * 8;
            const expectedHoursVal = timeStrToHours(d.expectedWorkHours) > 0 ? timeStrToHours(d.expectedWorkHours) : expectedHoursFromDays;
            const actualHoursVal = timeStrToHours(d.actualWorkHours);
            
            const payWt034 = Math.round(timeStrToHours(d.wt034) * CONFIG.OT_RATE_134 * hourlyRate);
            const payWt067 = Math.round(timeStrToHours(d.wt067) * CONFIG.OT_RATE_167 * hourlyRate);
            const payHd134 = Math.round(timeStrToHours(d.hd134) * CONFIG.OT_RATE_134 * hourlyRate);
            const payHd167 = Math.round(timeStrToHours(d.hd167) * CONFIG.OT_RATE_167 * hourlyRate);
            const payEarly = Math.round(timeStrToHours(d.earlyShift) * CONFIG.OT_RATE_134 * hourlyRate); 
            const payNoLunch = Math.round(timeStrToHours(d.noLunch) * CONFIG.OT_RATE_134 * hourlyRate); 
            const payHolidayOT = Math.round(timeStrToHours(d.holidayOT) * CONFIG.OT_RATE_134 * hourlyRate);
            const allowances = safeNum(d.lunchAllowance) + safeNum(d.businessBonus) + safeNum(d.otherBonus);
            const totalAdditions = payWt034 + payWt067 + payHd134 + payHd167 + payEarly + payNoLunch + payHolidayOT + allowances;
            const grossPay = safeNum(emp.baseSalary) + totalAdditions;

            const dedSick = Math.round(timeStrToHours(d.sickLeave) * CONFIG.SICK_LEAVE_RATE * hourlyRate);
            const dedPersonal = Math.round(timeStrToHours(d.personalLeave) * CONFIG.PERSONAL_LEAVE_RATE * hourlyRate);
            
            const totalLeaveHours = timeStrToHours(d.sickLeave) + timeStrToHours(d.personalLeave) + timeStrToHours(d.annualLeave) + timeStrToHours(d.bereavementLeave);
            const effectiveActualHours = actualHoursVal + totalLeaveHours; 

            let calcLateHoursVal = 0; 
            if (expectedHoursVal > 0 && effectiveActualHours < expectedHoursVal) {
                calcLateHoursVal = expectedHoursVal - effectiveActualHours;
            }
            if (calcLateHoursVal < 0.01) calcLateHoursVal = 0;

            const dedLate = Math.round(calcLateHoursVal * 1.0 * hourlyRate);
            const dedAbsent = Math.round(timeStrToHours(d.absentTime) * 1.0 * hourlyRate); 

            // V38.0 修正：使用員工設定的 pensionRate，而非硬編碼
            const pensionRate = safeNum(emp.pensionRate) || CONFIG.DEFAULT_PENSION_RATE; 
            const laborBase = safeNum(emp.laborInsuranceBase); 
            const employerPensionContribution = Math.round(laborBase * pensionRate);
            
            // 加班費總和
            const overtimePay = payWt034 + payWt067 + payHd134 + payHd167 + payEarly + payNoLunch + payHolidayOT;
            
            // V38.0 修正：勞健保扣款邏輯 - 避免重複計算
            // hasImportedInsurance=true: deduction 欄位就是勞健保費
            // hasImportedInsurance=false: 使用員工預設的勞健保費，deduction 欄位作為其他扣款
            let insuranceFee = d.hasImportedInsurance ? safeNum(d.deduction) : (safeNum(emp.laborFee) + safeNum(emp.healthFee));
            let otherDeduction = d.hasImportedInsurance ? 0 : safeNum(d.deduction);
            let finalDeduction = dedSick + dedPersonal + dedLate + dedAbsent + insuranceFee + otherDeduction;
            
            return { 
                hourlyRate, payWt034, payWt067, payHd134, payHd167, payEarly, payNoLunch, payHolidayOT, 
                overtimePay,
                dedSick, dedPersonal, dedLate, dedAbsent, otherDeduction,
                calcLateHoursVal,
                calcLateHoursStr: hoursToTimeStr(calcLateHoursVal), 
                expectedHoursVal, 
                expectedHoursStr: hoursToTimeStr(expectedHoursVal), 
                employerPensionContribution, pensionRate,
                totalAdditions, finalDeduction, netPay: grossPay - finalDeduction, insuranceFee, grossPay 
            };
        }

        const INITIAL_EMPLOYEES = [{ 
            id: 1, name: '範例-張耀升', empId: 'W0001', baseSalary: 28590, 
            laborFee: 1100, healthFee: 750, 
            laborInsuranceBase: 30300, 
            healthInsuranceBase: 30300, 
            title: '作業員', department: '生產部', lastRaiseDate: '2024-01-01',
            defaultBusinessBonus: 1000
        }];
        
        const INITIAL_PAYROLL_DATA = [{ 
            empId: 1, period: '2025-11', wt034:"00:00", wt067:"00:00", hd134:"00:00", hd167:"00:00", earlyShift:"00:00", noLunch:"00:00", holidayOT:"00:00", 
            sickLeave:"00:00", personalLeave:"00:00", annualLeave:"00:00", bereavementLeave:"00:00", 
            lunchAllowance:0, businessBonus:0, otherBonus:0, deduction:0, 
            expectedWorkHours:"00:00",
            expectedWorkDays: 20, 
            actualWorkHours:"160:00", absentTime:"00:00", note:'' 
        }];

        const PayrollApp = () => {
            const toast = useToast();
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [appId, setAppId] = useState(null);
            const [isCloudReady, setIsCloudReady] = useState(false);
            const [isOffline, setIsOffline] = useState(false); 
            const [isBackupModalOpen, setIsBackupModalOpen] = useState(false);
            const backupFileInputRef = useRef(null); 

            const safeParse = (key, defaultVal) => { try { return JSON.parse(localStorage.getItem(key)) || defaultVal; } catch(e) { return defaultVal; } };
            const [activeTab, setActiveTab] = useState('input');
            const [employees, setEmployees] = useState(() => safeParse('payroll_employees', INITIAL_EMPLOYEES));
            const [payrollData, setPayrollData] = useState(() => safeParse('payroll_data', INITIAL_PAYROLL_DATA));
            const [monthlyStatus, setMonthlyStatus] = useState(() => safeParse('payroll_status', {}));
            const [currentPeriod, setCurrentPeriod] = useState(new Date().toISOString().slice(0, 7));
            
            const [editingEmp, setEditingEmp] = useState(null);
            const [isEmpModalOpen, setIsEmpModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [isBulkModalOpen, setIsBulkModalOpen] = useState(false);
            const [mobileEditItem, setMobileEditItem] = useState(null);
            const [hoursPreviewItem, setHoursPreviewItem] = useState(null);  // V38.2 時數預覽

            const [bulkTargetSalary, setBulkTargetSalary] = useState(29500);
            const [bulkFilterType, setBulkFilterType] = useState('salary');
            const [bulkFilterValue, setBulkFilterValue] = useState(28590);
            const fileInputRef = useRef(null);
            
            const [selectedEmpIds, setSelectedEmpIds] = useState(new Set());

            // Firebase Init
            useEffect(() => {
                const initFirebase = async () => {
                    while (!window.firebaseModules) { await new Promise(resolve => setTimeout(resolve, 100)); }
                    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore } = window.firebaseModules;
                    try {
                        const app = initializeApp(USER_FIREBASE_CONFIG);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        setAppId("terrysalary");
                        setDb(firestore);

                        await signInAnonymously(auth);
                        onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            setIsCloudReady(true);
                            document.getElementById('loading-screen').style.display = 'none';
                        });
                    } catch (error) {
                        console.error("Firebase Init Failed", error);
                        setIsCloudReady(false); 
                        document.getElementById('loading-screen').style.display = 'none';
                        setIsOffline(true);
                    }
                };
                initFirebase();
            }, []);

            // Data Sync
            useEffect(() => {
                if (isCloudReady && db && user?.uid && !isOffline) {
                    const { collection, onSnapshot } = window.firebaseModules;
                    const handleError = (err) => {
                        console.error("Firestore Error:", err);
                        if (err.code === 'resource-exhausted') {
                            toast.warning("⚠️ 雲端讀取額度已用盡，系統已自動切換至「離線模式」");
                            setIsOffline(true);
                        }
                    };

                    const empUnsub = onSnapshot(collection(db, 'payroll_system', user.uid, 'employees'), (snap) => { 
                        const list = snap.docs.map(d => {
                            const data = d.data();
                            return { 
                                ...data, 
                                laborInsuranceBase: safeNum(data.laborInsuranceBase), 
                                healthInsuranceBase: safeNum(data.healthInsuranceBase),
                                defaultBusinessBonus: safeNum(data.defaultBusinessBonus) 
                            };
                        }); 
                        if(list.length > 0) setEmployees(list); 
                    }, handleError);
                    const payUnsub = onSnapshot(collection(db, 'payroll_system', user.uid, 'payroll'), (snap) => { const list = snap.docs.map(d => d.data()); if(list.length > 0) setPayrollData(list); }, handleError);
                    const statUnsub = onSnapshot(collection(db, 'payroll_system', user.uid, 'status'), (snap) => { const obj = {}; snap.docs.forEach(d => obj[d.id] = d.data().status); setMonthlyStatus(obj); }, handleError);
                    return () => { empUnsub(); payUnsub(); statUnsub(); };
                } 
            }, [isCloudReady, db, user?.uid, isOffline]);

            // Local Backup
            useEffect(() => {
                localStorage.setItem('payroll_employees', JSON.stringify(employees));
                localStorage.setItem('payroll_data', JSON.stringify(payrollData));
                localStorage.setItem('payroll_status', JSON.stringify(monthlyStatus));
            }, [employees, payrollData, monthlyStatus]);

            const sortedEmployees = useMemo(() => [...employees].sort((a, b) => (b.empId || "").localeCompare(a.empId || "", undefined, { numeric: true, sensitivity: 'base' })), [employees]);

            const fullPayrollListFlat = useMemo(() => sortedEmployees.map(emp => {
                 let data = payrollData.find(d => d.empId === emp.empId && d.period === currentPeriod) || { empId: emp.empId, period: currentPeriod };
                
                const defaultBonus = safeNum(emp.defaultBusinessBonus) || 0;
                const monthlyBonus = (safeNum(data.businessBonus) > 0 || data.businessBonus === 0) ? safeNum(data.businessBonus) : defaultBonus;

                const safeData = {
                    wt034: data.wt034||"00:00", wt067: data.wt067||"00:00", hd134: data.hd134||"00:00", hd167: data.hd167||"00:00",
                    earlyShift: data.earlyShift||"00:00", noLunch: data.noLunch||"00:00", holidayOT: data.holidayOT||"00:00",
                    sickLeave: data.sickLeave||"00:00", personalLeave: data.personalLeave||"00:00", annualLeave: data.annualLeave||"00:00", bereavementLeave: data.bereavementLeave||"00:00",
                    lateTime: data.lateTime||"00:00", absentTime: data.absentTime||"00:00", 
                    lunchAllowance: data.lunchAllowance||0, 
                    businessBonus: monthlyBonus, 
                    otherBonus: data.otherBonus||0,
                    deduction: data.deduction||0, note: data.note||'', hasImportedInsurance: data.hasImportedInsurance,
                    expectedWorkHours: data.expectedWorkHours||"00:00", 
                    expectedWorkDays: data.expectedWorkDays||0, 
                    actualWorkHours: data.actualWorkHours||"00:00"
                };
                return { ...emp, ...safeData, ...calculateSalary(emp, safeData) };
            }), [sortedEmployees, payrollData, currentPeriod]);

            const chunkedPayrollList = useMemo(() => chunkArray(fullPayrollListFlat, 4), [fullPayrollListFlat]);

            // CRUD (V38.0 使用 useCallback 優化)
            const saveEmp = useCallback(async (emp) => { 
                // 先更新 state（使用函數式更新避免閉包問題）
                setEmployees(prev => {
                    const exists = prev.some(e => e.id === emp.id);
                    return exists ? prev.map(e => e.id === emp.id ? emp : e) : [...prev, emp];
                });
                
                // 同步到 Firebase
                if (db && user && !isOffline) { 
                    try {
                        const { doc, setDoc } = window.firebaseModules; 
                        await setDoc(doc(db, 'payroll_system', user.uid, 'employees', String(emp.id)), emp); 
                    } catch(e) { 
                        console.error('Firebase 同步失敗:', e); 
                        setIsOffline(true); 
                    } 
                }
            }, [db, user, isOffline]);

            const delEmp = useCallback(async (id) => { 
                if (db && user && !isOffline) { 
                    try {
                        const { doc, deleteDoc } = window.firebaseModules; 
                        await deleteDoc(doc(db, 'payroll_system', user.uid, 'employees', String(id))); 
                    } catch(e) { console.error(e); setIsOffline(true); }
                } 
                setEmployees(prev => prev.filter(e=>e.id!==id)); 
            }, [db, user, isOffline]);

            const savePay = useCallback(async (data) => { 
                if (isLocked) return; 
                if (db && user && !isOffline) { 
                    try {
                        const { doc, setDoc } = window.firebaseModules; 
                        const key = `${data.empId}_${data.period}`; 
                        await setDoc(doc(db, 'payroll_system', user.uid, 'payroll', key), data); 
                    } catch(e) { console.error(e); setIsOffline(true); }
                } 
                setPayrollData(prev => { const idx = prev.findIndex(p=>p.empId===data.empId && p.period===data.period); if(idx>=0) { const n=[...prev]; n[idx]=data; return n; } return [...prev, data]; }); 
            }, [isLocked, db, user, isOffline]);

            const saveStat = useCallback(async (period, status) => { 
                if (db && user && !isOffline) { 
                    try {
                        const { doc, setDoc } = window.firebaseModules; 
                        await setDoc(doc(db, 'payroll_system', user.uid, 'status', period), { status }); 
                    } catch(e) { console.error(e); setIsOffline(true); }
                } 
                setMonthlyStatus(prev => ({...prev, [period]: status})); 
            }, [db, user, isOffline]);

            const isLocked = monthlyStatus[currentPeriod] === 'locked';
            const toggleLock = useCallback(() => { 
                if(confirm(`確定要${isLocked?'解除結案':'結案'}?`)) {
                    saveStat(currentPeriod, isLocked?'active':'locked'); 
                    toast.success(isLocked ? '已解除結案' : '本月已結案');
                }
            }, [isLocked, currentPeriod, saveStat, toast]);

            const updateVal = useCallback((empId, field, value) => {
                if (isLocked) return;
                const isTimeField = ['note', 'wt034','wt067','hd134','hd167','earlyShift','noLunch','holidayOT','sickLeave','personalLeave','annualLeave','actualWorkHours', 'expectedWorkHours', 'lateTime', 'absentTime'].includes(field);
                const val = isTimeField ? value : Number(value);
                
                // V38.0 輸入驗證
                if (!isTimeField && field !== 'note') {
                    const validation = Validators.salary(val);
                    if (!validation.valid) {
                        toast.error(validation.message);
                        return;
                    }
                }
                
                const existing = payrollData.find(p => p.empId === empId && p.period === currentPeriod);
                const newData = existing ? { ...existing, [field]: val } : { empId, period: currentPeriod, [field]: val };
                if (field === 'deduction') newData.hasImportedInsurance = false;
                savePay(newData);
            }, [isLocked, payrollData, currentPeriod, savePay, toast]);
            
            const handleTimeBlur = useCallback((empId, field, value) => updateVal(empId, field, formatInputTime(value)), [updateVal]);
            
            // ===== 資料備份/還原功能 (V38.0 新增) =====
            const handleExportBackup = useCallback(() => {
                const backupData = {
                    version: 'V38.0',
                    exportDate: new Date().toISOString(),
                    employees: employees,
                    payrollData: payrollData,
                    monthlyStatus: monthlyStatus
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `薪資系統備份_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                toast.success('備份檔案已下載');
                setIsBackupModalOpen(false);
            }, [employees, payrollData, monthlyStatus, toast]);
            
            const handleImportBackup = useCallback((e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        if (!data.employees || !data.payrollData) {
                            throw new Error('備份檔案格式錯誤');
                        }
                        
                        if (!confirm(`確定要還原備份嗎？\n\n備份日期: ${data.exportDate || '未知'}\n員工數量: ${data.employees.length}\n薪資記錄: ${data.payrollData.length}\n\n⚠️ 此操作會覆蓋現有資料！`)) {
                            return;
                        }
                        
                        setEmployees(data.employees);
                        setPayrollData(data.payrollData);
                        if (data.monthlyStatus) setMonthlyStatus(data.monthlyStatus);
                        
                        // 同步到雲端
                        if (db && user && !isOffline) {
                            data.employees.forEach(async (emp) => {
                                try {
                                    const { doc, setDoc } = window.firebaseModules;
                                    await setDoc(doc(db, 'payroll_system', user.uid, 'employees', String(emp.id)), emp);
                                } catch(e) { console.error(e); }
                            });
                            data.payrollData.forEach(async (pay) => {
                                try {
                                    const { doc, setDoc } = window.firebaseModules;
                                    const key = `${pay.empId}_${pay.period}`;
                                    await setDoc(doc(db, 'payroll_system', user.uid, 'payroll', key), pay);
                                } catch(e) { console.error(e); }
                            });
                        }
                        
                        toast.success(`還原成功！已載入 ${data.employees.length} 位員工資料`);
                        setIsBackupModalOpen(false);
                    } catch (err) {
                        toast.error(`還原失敗: ${err.message}`);
                    }
                };
                reader.readAsText(file);
                if (backupFileInputRef.current) backupFileInputRef.current.value = '';
            }, [db, user, isOffline, toast]);
            
            // Checkbox
            const toggleSelectAll = useCallback(() => { if (selectedEmpIds.size === sortedEmployees.length) setSelectedEmpIds(new Set()); else setSelectedEmpIds(new Set(sortedEmployees.map(e => e.id))); }, [selectedEmpIds, sortedEmployees]);
            const toggleSelect = useCallback((id) => { const newSet = new Set(selectedEmpIds); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); setSelectedEmpIds(newSet); }, [selectedEmpIds]);

            const handleExcel = (e) => {
                if (isLocked) { toast.warning("本月已結案，無法匯入"); return; }
                const file = e.target.files[0]; if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: "", raw: false });
                        let hRow = -1;
                        for(let i=0; i < Math.min(data.length, 20); i++) {
                            if(JSON.stringify(data[i]).includes("員工編號")) { hRow = i; break; }
                        }
                        if(hRow === -1) throw new Error("找不到標題列 (需包含'員工編號')");
                        const headers = data[hRow].map(h => String(h).trim());
                        const rows = data.slice(hRow + 1);

                        const COLUMN_DEF = [
                            { key: 'id', keywords: ['員工編號', 'ID'] },
                            { key: 'name', keywords: ['員工姓名', '姓名'] },
                            { key: 'dept', keywords: ['部門'] },
                            { key: 'title', keywords: ['職位', '職稱'] },
                            { key: 'base', keywords: ['基本底薪', '底薪'] },
                            { key: 'labIns', keywords: ['勞保投保', '勞保金額'] }, 
                            { key: 'healthIns', keywords: ['健保投保', '健保金額'] }, 
                            { key: 'early', keywords: ['提前', '提早'] },
                            { key: 'noLunch', keywords: ['中午', '未休'] },
                            { key: 'holidayOT', keywords: ['星期日', '休加'] },
                            { key: 'wt034', keywords: ['平日0.34', '平日0.33', '平加1.34', '平加(1.34)', '平加 1.34'] }, 
                            { key: 'wt067', keywords: ['平日0.67', '平日0.66', '平加1.67', '平加(1.67)', '平加 1.67'] },
                            { key: 'hd134', keywords: ['例假1.34', '假日1.33', '例假1.33', '例假(1.34)', '例假 1.34'] },
                            { key: 'hd167', keywords: ['例假1.67', '假日1.66', '例假1.66', '例假(1.67)', '例假 1.67'] },
                            { key: 'expDays', keywords: ['應上班天數', '應勤天數'] },
                            { key: 'expHours', keywords: ['應上班時數', '應上班', '應上班(H)'] },
                            { key: 'actHours', keywords: ['實上班', '實際出勤', '實工', '實工/實工'] }, 
                            { key: 'sickH', keywords: ['病假時數', '病假小時', '病假'] }, 
                            { key: 'personalH', keywords: ['事假時數', '事假小時', '事假'] },
                            { key: 'annualH', keywords: ['特休時數', '年假時數', '特休'] },
                            { key: 'bereavementH', keywords: ['喪假時數', '喪假小時', '喪假'] },
                            { key: 'absentH', keywords: ['曠職時數', '曠職小時', '曠職'] }, 
                            { key: 'lunch', keywords: ['午餐', '津貼'] },
                            { key: 'businessBonus', keywords: ['業務', '職務'] },
                            { key: 'otherBonus', keywords: ['其它加項', '其他加項', '其他津貼', '其它'] },
                            { key: 'ins', keywords: ['勞健保', '勞健'] },
                            { key: 'note', keywords: ['備註'] }
                        ];

                        const colIdx = {};
                        COLUMN_DEF.forEach(def => {
                            colIdx[def.key] = -1;
                            for (let i = 0; i < headers.length; i++) {
                                const h = headers[i];
                                if (def.key === 'base' && h.includes('實發')) continue; 
                                if (def.keywords.some(k => h.includes(k))) {
                                    colIdx[def.key] = i;
                                    break;
                                }
                            }
                        });

                        // V38.0 修正：改用依序處理，避免閉包和並行競爭問題
                        let count = 0;
                        let newEmployees = [...employees];  // 創建本地副本
                        let newPayrollData = [...payrollData];
                        
                        for (const row of rows) {
                            const eid = row[colIdx.id];
                            if (!eid) continue;  // 跳過空行
                            
                            // 清理員工編號（移除空白）
                            const cleanEid = String(eid).trim();
                            if (!cleanEid) continue;

                            const rowBase = colIdx.base !== -1 ? (parseInt(row[colIdx.base]) || 0) : 0;
                            const rowDept = colIdx.dept !== -1 ? String(row[colIdx.dept] || "") : "";
                            const rowName = colIdx.name !== -1 ? String(row[colIdx.name] || "") : "";
                            const rowTitle = colIdx.title !== -1 ? String(row[colIdx.title] || "") : "員工";
                            const rowLabIns = colIdx.labIns !== -1 ? (parseInt(row[colIdx.labIns]) || 0) : 0;
                            const rowHthIns = colIdx.healthIns !== -1 ? (parseInt(row[colIdx.healthIns]) || 0) : 0;
                            const rowExpDays = colIdx.expDays !== -1 ? (parseInt(row[colIdx.expDays]) || 0) : 0;
                            const rowDefaultBonus = colIdx.businessBonus !== -1 ? (parseInt(row[colIdx.businessBonus]) || 0) : 0;

                            // 從本地副本中查找員工
                            let emp = newEmployees.find(e => e.empId === cleanEid);
                            const currentBase = rowBase || 28590;

                            if (!emp) {
                                // 新員工
                                emp = { 
                                    id: Date.now() + Math.random(), 
                                    empId: cleanEid, 
                                    name: rowName || cleanEid, 
                                    baseSalary: currentBase, 
                                    laborFee: 0, healthFee: 0, title: rowTitle, 
                                    department: rowDept, 
                                    lastRaiseDate: new Date().toISOString().split('T')[0],
                                    laborInsuranceBase: rowLabIns || CONFIG.DEFAULT_LABOR_BASE,
                                    healthInsuranceBase: rowHthIns || CONFIG.DEFAULT_LABOR_BASE,
                                    defaultBusinessBonus: rowDefaultBonus,
                                    pensionRate: CONFIG.DEFAULT_PENSION_RATE
                                };
                                newEmployees.push(emp);  // 加入本地副本
                            } else {
                                // 更新現有員工
                                if (rowBase && emp.baseSalary !== rowBase) emp.baseSalary = rowBase;
                                if (rowDept && emp.department !== rowDept) emp.department = rowDept;
                                if (rowTitle && emp.title !== rowTitle) emp.title = rowTitle;
                                if (rowLabIns && emp.laborInsuranceBase !== rowLabIns) emp.laborInsuranceBase = rowLabIns;
                                if (rowHthIns && emp.healthInsuranceBase !== rowHthIns) emp.healthInsuranceBase = rowHthIns;
                                if (rowDefaultBonus && emp.defaultBusinessBonus !== rowDefaultBonus) emp.defaultBusinessBonus = rowDefaultBonus;
                            }

                            const noteText = colIdx.note !== -1 ? String(row[colIdx.note] || "") : "";
                            const parsedLeaves = parseLeave(noteText); 

                            const getVal = (key, fallback = "00:00") => {
                                const idx = colIdx[key];
                                if (idx !== -1 && row[idx]) {
                                    return normalizeToTimeStr(row[idx]);
                                }
                                return normalizeToTimeStr(fallback);
                            };
                            
                            const getNum = (key) => colIdx[key] !== -1 ? (parseInt(row[colIdx[key]]) || 0) : 0;

                            const monthlyBonus = (colIdx.businessBonus !== -1 && row[colIdx.businessBonus]) ? getNum('businessBonus') : (safeNum(emp.defaultBusinessBonus) || 0);

                            const entry = {
                                empId: emp.empId, 
                                period: currentPeriod,
                                wt034: getVal('wt034'), wt067: getVal('wt067'), hd134: getVal('hd134'), hd167: getVal('hd167'),
                                earlyShift: getVal('early'), noLunch: getVal('noLunch'), holidayOT: getVal('holidayOT'),
                                sickLeave: getVal('sickH', parsedLeaves.sickLeave),
                                personalLeave: getVal('personalH', parsedLeaves.personalLeave),
                                annualLeave: getVal('annualH', parsedLeaves.annualLeave),
                                bereavementLeave: getVal('bereavementH', parsedLeaves.bereavementLeave),
                                absentTime: getVal('absentH'),
                                expectedWorkDays: rowExpDays || 0, 
                                expectedWorkHours: getVal('expHours'),
                                actualWorkHours: getVal('actHours'),
                                lunchAllowance: getNum('lunch'),
                                businessBonus: monthlyBonus, 
                                otherBonus: getNum('otherBonus'),
                                deduction: getNum('ins'),
                                hasImportedInsurance: colIdx.ins !== -1 && getNum('ins') > 0,
                                note: noteText
                            };
                            
                            // 更新本地薪資副本
                            const payIdx = newPayrollData.findIndex(p => p.empId === emp.empId && p.period === currentPeriod);
                            if (payIdx >= 0) {
                                newPayrollData[payIdx] = entry;
                            } else {
                                newPayrollData.push(entry);
                            }
                            
                            count++;
                        }
                        
                        // 批量更新 state（只觸發一次渲染）
                        setEmployees(newEmployees);
                        setPayrollData(newPayrollData);
                        
                        // 同步到雲端（背景執行）
                        if (db && user && !isOffline) {
                            const { doc, setDoc } = window.firebaseModules;
                            newEmployees.forEach(emp => {
                                setDoc(doc(db, 'payroll_system', user.uid, 'employees', String(emp.id)), emp).catch(console.error);
                            });
                            newPayrollData.filter(p => p.period === currentPeriod).forEach(pay => {
                                const key = `${pay.empId}_${pay.period}`;
                                setDoc(doc(db, 'payroll_system', user.uid, 'payroll', key), pay).catch(console.error);
                            });
                        }
                        
                        setIsImportModalOpen(false); 
                        toast.success(`匯入完成！成功處理 ${count} 筆資料`); 
                        if(fileInputRef.current) fileInputRef.current.value = '';

                    } catch(err) {
                        console.error(err);
                        toast.error(`匯入失敗: ${err.message}`);
                    }
                };
                reader.readAsBinaryString(file);
            };

            const handleSaveEmployee = async (e) => { 
                e.preventDefault(); 
                const fd = new FormData(e.target); 
                
                // V38.0 輸入驗證
                const empId = fd.get('empId');
                const name = fd.get('name');
                const baseSalary = Number(fd.get('baseSalary'));
                
                if (!empId || !empId.trim()) {
                    toast.error('員工編號為必填');
                    return;
                }
                if (!name || !name.trim()) {
                    toast.error('姓名為必填');
                    return;
                }
                if (!baseSalary || baseSalary <= 0) {
                    toast.error('請輸入有效的底薪');
                    return;
                }
                
                // 檢查編號是否重複 (新增時)
                if (!editingEmp && employees.some(emp => emp.empId === empId.trim())) {
                    toast.error('員工編號已存在');
                    return;
                }
                
                const newEmp = { 
                    id: editingEmp?editingEmp.id:Date.now(), 
                    name: name.trim(), 
                    empId: empId.trim(), 
                    title: fd.get('title') || '員工', 
                    department: fd.get('department') || '', 
                    baseSalary: baseSalary, 
                    laborFee: Number(fd.get('laborFee')) || 0, 
                    healthFee: Number(fd.get('healthFee')) || 0, 
                    lastRaiseDate: fd.get('lastRaiseDate') || new Date().toISOString().split('T')[0],
                    laborInsuranceBase: Number(fd.get('laborInsuranceBase')) || CONFIG.DEFAULT_LABOR_BASE,
                    healthInsuranceBase: Number(fd.get('healthInsuranceBase')) || CONFIG.DEFAULT_LABOR_BASE,
                    defaultBusinessBonus: Number(fd.get('defaultBusinessBonus')) || 0,
                    pensionRate: Number(fd.get('pensionRate')) || CONFIG.DEFAULT_PENSION_RATE
                }; 
                await saveEmp(newEmp);
                
                // V38.3: 同步更新當月結算分頁的業務獎金 (僅限未結案)
                if (!isLocked) {
                    const newBusinessBonus = Number(fd.get('defaultBusinessBonus')) || 0;
                    const existingPayroll = payrollData.find(p => p.empId === newEmp.empId && p.period === currentPeriod);
                    const updatedPayroll = existingPayroll 
                        ? { ...existingPayroll, businessBonus: newBusinessBonus }
                        : { empId: newEmp.empId, period: currentPeriod, businessBonus: newBusinessBonus };
                    await savePay(updatedPayroll);
                    toast.success(editingEmp ? '員工資料已更新，當月業務獎金已同步' : '新員工已新增');
                } else {
                    toast.success(editingEmp ? '員工資料已更新 (本月已結案，業務獎金未同步)' : '新員工已新增');
                }
                
                setIsEmpModalOpen(false); 
            };

            const handleBulkSubmit = async (e) => { 
                e.preventDefault(); 
                const target = Number(bulkTargetSalary); 
                if(!target || target <= 0) { toast.error("請輸入有效的目標底薪"); return; }
                
                const today = new Date().toISOString().split('T')[0]; 
                let c=0; 
                const targets = employees.filter(e => {
                    const isSelected = selectedEmpIds.size > 0 ? selectedEmpIds.has(e.id) : true;
                    const isWorker = e.title === '作業員';
                    if (!isSelected) return false;
                    if (!isWorker) return false;
                    if (selectedEmpIds.size === 0) {
                        if (bulkFilterType==='all') return true; 
                        if (bulkFilterType==='title' && e.title.includes(String(bulkFilterValue))) return true; 
                        if (bulkFilterType==='salary' && e.baseSalary===Number(bulkFilterValue)) return true;
                    }
                    return true;
                }).filter(e => e.title === '作業員'); 
                
                for(let emp of targets) { 
                    if (emp.baseSalary !== target) { 
                        c++; 
                        await saveEmp({...emp, baseSalary: target, lastRaiseDate: today}); 
                    } 
                } 
                setIsBulkModalOpen(false); 
                setSelectedEmpIds(new Set()); 
                toast.success(`成功更新 ${c} 位作業員的底薪`); 
            };
            
            const deleteEmployee = (id) => { 
                if(confirm('確定刪除此員工資料？')) {
                    delEmp(id); 
                    toast.success('員工已刪除');
                }
            };

            const handleExportPaymentList = () => { 
                const exportData = fullPayrollListFlat.map((item, index) => ({ 
                    '序號': index+1, 
                    '部門': item.department, 
                    '員工編號': item.empId, 
                    '姓名': item.name, 
                    '職稱': item.title, 
                    '底薪': item.baseSalary, 
                    '實發': item.netPay,
                    '公司勞退提撥': item.employerPensionContribution 
                })); 
                const ws = XLSX.utils.json_to_sheet(exportData); 
                const wb = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, ws, "薪資單"); 
                XLSX.writeFile(wb, "薪資單.xlsx"); 
            };

            return (
                <div className="min-h-screen pb-24 md:pb-10 bg-gray-50">
                    <nav className="bg-slate-800 text-white shadow-lg print-hidden sticky top-0 z-40 hidden md:block">
                        <div className="max-w-[1800px] mx-auto px-4 flex justify-between h-16 items-center">
                            <div className="flex items-center space-x-2"><Icons.Calculator className="w-6 h-6 text-yellow-400"/><span className="font-bold text-xl">薪資管理系統 V38.3</span></div>
                            <div className="flex space-x-2">
                                {isOffline && <span className="offline-badge mr-2 animate-pulse">⚠️ 離線模式 (配額額滿)</span>}
                                {user && !isOffline && <span className="flex items-center text-xs text-green-400 mr-4"><Icons.Cloud className="w-3 h-3 mr-1"/> 雲端同步</span>}
                                <button onClick={()=>setActiveTab('employees')} className={`px-3 py-1 rounded ${activeTab==='employees'?'bg-yellow-500 text-black':'hover:bg-slate-700'}`}>員工設定</button>
                                <button onClick={()=>setActiveTab('input')} className={`px-3 py-1 rounded ${activeTab==='input'?'bg-yellow-500 text-black':'hover:bg-slate-700'}`}>結算</button>
                                <button onClick={()=>setActiveTab('print')} className={`px-3 py-1 rounded ${activeTab==='print'?'bg-yellow-500 text-black':'hover:bg-slate-700'}`}>報表列印</button>
                                <button onClick={()=>setIsBackupModalOpen(true)} className="px-3 py-1 rounded hover:bg-slate-700 text-gray-300" title="備份/還原"><Icons.Settings className="w-4 h-4"/></button>
                            </div>
                        </div>
                    </nav>
                    <div className="md:hidden bg-slate-800 text-white p-4 sticky top-0 z-40 flex justify-between items-center print-hidden"><span className="font-bold text-lg flex items-center">薪資管理 {user && <Icons.Cloud className="w-3 h-3 ml-2 text-green-400"/>}</span><input type="month" value={currentPeriod} onChange={e=>setCurrentPeriod(e.target.value)} className="text-black text-sm rounded px-2 py-1"/></div>
                    <main className="max-w-[1800px] mx-auto p-4 md:p-6 print-block print:p-0 print:max-w-none">
                        {activeTab === 'employees' && (
                            <div className="space-y-4 animate-fade-in print-hidden">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-xl font-bold text-gray-800 hidden md:block">員工資料</h2>
                                    <div className="flex space-x-2 w-full md:w-auto">
                                        <button onClick={()=>{setEditingEmp(null);setIsEmpModalOpen(true)}} className="flex-1 md:flex-none flex items-center justify-center bg-blue-600 text-white px-4 py-2 rounded shadow">
                                            <Icons.Plus className="w-4 h-4 mr-1"/> 新增
                                        </button>
                                        <button onClick={()=>setIsBulkModalOpen(true)} className="flex-1 md:flex-none bg-orange-100 text-orange-700 px-4 py-2 rounded border border-orange-200">調薪</button>
                                    </div>
                                </div>
                                <div className="hidden md:block bg-white rounded-xl shadow overflow-hidden">
                                    <table className="min-w-full text-sm">
                                        <thead className="bg-slate-50 text-left">
                                            <tr>
                                                <th className="p-3 checkbox-cell"><input type="checkbox" className="checkbox-input" checked={selectedEmpIds.size === sortedEmployees.length && sortedEmployees.length > 0} onChange={toggleSelectAll}/></th>
                                                <th className="p-3">部門</th><th className="p-3">編號</th><th className="p-3">姓名</th><th className="p-3">職位</th><th className="p-3">底薪</th>
                                                <th className="p-3">勞保投保</th><th className="p-3">健保投保</th><th className="p-3">業務獎金</th><th className="p-3">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {sortedEmployees.map(e => (
                                                <tr key={e.id} className="border-b hover:bg-slate-50">
                                                    <td className="p-3 checkbox-cell"><input type="checkbox" className="checkbox-input" checked={selectedEmpIds.has(e.id)} onChange={()=>toggleSelect(e.id)}/></td>
                                                    <td className="p-3">{e.department}</td>
                                                    <td className="p-3">{e.empId}</td>
                                                    <td className="p-3 font-bold">{e.name}</td>
                                                    <td className="p-3">{e.title}</td>
                                                    <td className="p-3 font-mono">${formatNumber(e.baseSalary)}</td>
                                                    <td className="p-3 font-mono">${formatNumber(e.laborInsuranceBase)}</td>
                                                    <td className="p-3 font-mono">${formatNumber(e.healthInsuranceBase)}</td>
                                                    <td className="p-3 font-mono">${formatNumber(e.defaultBusinessBonus)}</td>
                                                    <td className="p-3 space-x-2">
                                                        <button onClick={()=>{setEditingEmp(e);setIsEmpModalOpen(true)}} className="text-blue-600">編輯</button>
                                                        <button onClick={()=>deleteEmployee(e.id)} className="text-red-600">刪除</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="grid grid-cols-1 gap-4 md:hidden">
                                    <div className="bg-white p-3 rounded shadow flex justify-between items-center"><span className="font-bold text-gray-600">全選/取消全選</span><input type="checkbox" className="w-6 h-6" checked={selectedEmpIds.size === sortedEmployees.length && sortedEmployees.length > 0} onChange={toggleSelectAll}/></div>
                                    {sortedEmployees.map(e => (
                                        <div key={e.id} className={`bg-white p-4 rounded-lg shadow flex justify-between items-center border-l-4 ${selectedEmpIds.has(e.id) ? 'border-orange-500 bg-orange-50' : 'border-blue-500'}`}>
                                            <div className="flex items-center"><input type="checkbox" className="w-6 h-6 mr-4" checked={selectedEmpIds.has(e.id)} onChange={()=>toggleSelect(e.id)}/><div><div className="font-bold text-lg">{e.name} <span className="text-sm text-gray-500">({e.empId})</span></div><div className="text-sm text-gray-600">{e.department} | {e.title}</div><div className="text-blue-600 font-bold mt-1">${formatNumber(e.baseSalary)}</div></div></div>
                                            <div className="flex space-x-3"><button onClick={()=>{setEditingEmp(e);setIsEmpModalOpen(true)}}><Icons.Edit className="w-6 h-6 text-gray-400"/></button><button onClick={()=>deleteEmployee(e.id)}><Icons.Trash2 className="w-6 h-6 text-red-400"/></button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'input' && (
                            <div className="space-y-4 animate-fade-in print-hidden">
                                <div className="bg-white p-4 rounded-lg shadow text-xs mb-4">
                                    <h3 className="font-bold text-lg text-gray-700 border-b pb-1 mb-2">💰 結算公式說明 (V38.3)</h3>
                                    <ul className="list-disc list-inside space-y-1 text-gray-600">
                                        <li>**時薪計算**：`時薪 = 底薪 / 240` (四捨五入)。</li>
                                        <li>**應勤天數**：請在表格中設定**當月應出勤天數**，系統將以此計算應勤時數 (天數 x 8H)。</li>
                                        <li className="text-blue-600">**點擊員工姓名**：開啟時數預覽彈窗，方便對照考勤系統。</li>
                                    </ul>
                                </div>
                                <div className="hidden md:flex justify-between mb-4">
                                    <div className="flex items-center space-x-4">
                                        <input type="month" value={currentPeriod} onChange={e=>setCurrentPeriod(e.target.value)} className="border rounded px-2 py-1"/>
                                        {isLocked && <span className="text-red-600 font-bold bg-red-50 px-2 py-1 rounded">已結案</span>}
                                        <button onClick={toggleLock} className="text-sm underline text-gray-500">{isLocked ? '解鎖' : '鎖定'}</button>
                                    </div>
                                    <button onClick={()=>setIsImportModalOpen(true)} className={`px-4 py-2 bg-emerald-600 text-white rounded ${isLocked?'opacity-50':''}`} disabled={isLocked}>匯入 Excel</button>
                                </div>
                                
                                <div className="md:hidden flex justify-between items-center mb-2">
                                    <span className="text-gray-500 text-sm">{isLocked ? '🔒 本月已結案' : '🟢 編輯中'}</span>
                                    <button onClick={toggleLock} className="text-xs bg-gray-200 px-2 py-1 rounded">{isLocked ? '解鎖' : '結案'}</button>
                                </div>
                                
                                {!isLocked && (<button onClick={()=>setIsImportModalOpen(true)} className="md:hidden w-full py-3 bg-emerald-100 text-emerald-700 font-bold rounded-lg border border-emerald-200 mb-4 flex items-center justify-center"><Icons.FileSpreadsheet className="w-5 h-5 mr-2"/> 匯入 Excel</button>)}
                                
                                <div className="hidden md:block bg-white rounded-xl shadow-lg overflow-x-auto border border-gray-200">
                                    <table className="min-w-full text-xs whitespace-nowrap border-collapse">
                                        <thead>
                                            <tr className="bg-slate-700 text-white text-[11px]">
                                                <th className="px-2 py-1.5 sticky left-0 bg-slate-700 z-10 text-left">員工</th>
                                                <th className="px-1 py-1.5 text-right">本薪</th>
                                                <th className="px-1 py-1.5 bg-orange-600">應勤天</th> 
                                                <th className="px-1 py-1.5 bg-blue-600">應勤H</th> 
                                                <th className="px-1 py-1.5 bg-green-600">實工H</th>
                                                <th className="px-1 py-1.5 bg-indigo-500">平1.34</th>
                                                <th className="px-1 py-1.5 bg-indigo-500">平1.67</th>
                                                <th className="px-1 py-1.5 bg-purple-500">例1.34</th>
                                                <th className="px-1 py-1.5 bg-purple-500">例1.67</th>
                                                <th className="px-1 py-1.5 bg-slate-600">提早</th>
                                                <th className="px-1 py-1.5 bg-slate-600">未休</th>
                                                <th className="px-1 py-1.5 bg-slate-600">休加</th>
                                                <th className="px-1 py-1.5 bg-emerald-600">午餐</th>
                                                <th className="px-1 py-1.5 bg-emerald-600">業務</th>
                                                <th className="px-1 py-1.5 bg-emerald-600">其它</th>
                                                <th className="px-1 py-1.5 bg-red-500">病假</th>
                                                <th className="px-1 py-1.5 bg-red-600">事假</th>
                                                <th className="px-1 py-1.5 bg-sky-500">特休</th>
                                                <th className="px-1 py-1.5 bg-red-700">曠職</th>
                                                <th className="px-1 py-1.5 bg-amber-600">勞健</th>
                                                <th className="px-1 py-1.5 sticky right-0 bg-slate-800 z-10">實發</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {fullPayrollListFlat.map((item, idx) => (
                                                <tr key={item.id} className={`border-b border-gray-100 hover:bg-blue-50 transition ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                                    <td className={`px-2 py-1 sticky left-0 z-10 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                                                        <button 
                                                            onClick={() => setHoursPreviewItem(item)} 
                                                            className="font-bold text-blue-600 hover:text-blue-800 hover:underline text-left"
                                                            title="點擊查看時數明細"
                                                        >
                                                            {item.name}
                                                        </button>
                                                    </td>
                                                    <td className="px-1 py-1 text-right font-mono text-gray-700">${formatNumber(item.baseSalary)}</td> 
                                                    <td className="px-1 py-1 bg-orange-50"><input type="number" disabled={isLocked} className="w-12 px-1 py-0.5 border border-orange-200 rounded text-center text-orange-800 font-bold focus:ring-2 focus:ring-orange-400 focus:outline-none" value={item.expectedWorkDays} onChange={e=>updateVal(item.empId,'expectedWorkDays',e.target.value)}/></td> 
                                                    <td className="px-1 py-1 bg-blue-50"><input disabled={isLocked} className="w-14 px-1 py-0.5 border border-blue-200 rounded text-center text-blue-800 font-bold font-mono focus:ring-2 focus:ring-blue-400 focus:outline-none" value={item.expectedHoursStr} onChange={e=>updateVal(item.empId,'expectedWorkHours',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'expectedWorkHours',e.target.value)}/></td> 
                                                    <td className="px-1 py-1 bg-green-50"><input disabled={isLocked} className="w-14 px-1 py-0.5 border border-green-200 rounded text-center text-green-700 font-mono focus:ring-2 focus:ring-green-400 focus:outline-none" value={item.actualWorkHours} onChange={e=>updateVal(item.empId,'actualWorkHours',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'actualWorkHours',e.target.value)}/></td>
                                                    <td className="px-1 py-1 bg-indigo-50"><input disabled={isLocked} className="w-12 px-1 py-0.5 border border-indigo-200 rounded text-center font-mono focus:ring-2 focus:ring-indigo-400 focus:outline-none" value={item.wt034} onChange={e=>updateVal(item.empId,'wt034',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'wt034',e.target.value)}/></td>
                                                    <td className="px-1 py-1 bg-indigo-50"><input disabled={isLocked} className="w-12 px-1 py-0.5 border border-indigo-200 rounded text-center font-mono focus:ring-2 focus:ring-indigo-400 focus:outline-none" value={item.wt067} onChange={e=>updateVal(item.empId,'wt067',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'wt067',e.target.value)}/></td>
                                                    <td className="px-1 py-1 bg-purple-50"><input disabled={isLocked} className="w-12 px-1 py-0.5 border border-purple-200 rounded text-center font-mono focus:ring-2 focus:ring-purple-400 focus:outline-none" value={item.hd134} onChange={e=>updateVal(item.empId,'hd134',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'hd134',e.target.value)}/></td>
                                                    <td className="px-1 py-1 bg-purple-50"><input disabled={isLocked} className="w-12 px-1 py-0.5 border border-purple-200 rounded text-center font-mono focus:ring-2 focus:ring-purple-400 focus:outline-none" value={item.hd167} onChange={e=>updateVal(item.empId,'hd167',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'hd167',e.target.value)}/></td>
                                                    <td className="px-1 py-1"><input disabled={isLocked} className="w-12 px-1 py-0.5 border border-gray-200 rounded text-center font-mono focus:ring-2 focus:ring-gray-400 focus:outline-none" value={item.earlyShift} onChange={e=>updateVal(item.empId,'earlyShift',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'earlyShift',e.target.value)}/></td>
                                                    <td className="px-1 py-1"><input disabled={isLocked} className="w-12 px-1 py-0.5 border border-gray-200 rounded text-center font-mono focus:ring-2 focus:ring-gray-400 focus:outline-none" value={item.noLunch} onChange={e=>updateVal(item.empId,'noLunch',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'noLunch',e.target.value)}/></td>
                                                    <td className="px-1 py-1"><input disabled={isLocked} className="w-12 px-1 py-0.5 border border-gray-200 rounded text-center font-mono focus:ring-2 focus:ring-gray-400 focus:outline-none" value={item.holidayOT} onChange={e=>updateVal(item.empId,'holidayOT',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'holidayOT',e.target.value)}/></td>
                                                    <td className="px-1 py-1 bg-emerald-50"><input type="number" disabled={isLocked} className="w-14 px-1 py-0.5 border border-emerald-200 rounded text-center focus:ring-2 focus:ring-emerald-400 focus:outline-none" value={item.lunchAllowance} onChange={e=>updateVal(item.empId,'lunchAllowance',e.target.value)}/></td>
                                                    <td className="px-1 py-1 bg-emerald-50"><input type="number" disabled={isLocked} className="w-14 px-1 py-0.5 border border-emerald-200 rounded text-center font-bold text-emerald-700 focus:ring-2 focus:ring-emerald-400 focus:outline-none" value={item.businessBonus} onChange={e=>updateVal(item.empId,'businessBonus',e.target.value)}/></td>
                                                    <td className="px-1 py-1 bg-emerald-50"><input type="number" disabled={isLocked} className="w-14 px-1 py-0.5 border border-emerald-200 rounded text-center focus:ring-2 focus:ring-emerald-400 focus:outline-none" value={item.otherBonus} onChange={e=>updateVal(item.empId,'otherBonus',e.target.value)}/></td>
                                                    <td className="px-1 py-1 bg-red-50"><input disabled={isLocked} className="w-12 px-1 py-0.5 border border-red-200 rounded text-center font-mono text-red-600 focus:ring-2 focus:ring-red-400 focus:outline-none" value={item.sickLeave} onChange={(e) => updateVal(item.empId, 'sickLeave', e.target.value)} onBlur={(e) => handleTimeBlur(item.empId, 'sickLeave', e.target.value)} /></td>
                                                    <td className="px-1 py-1 bg-red-50"><input disabled={isLocked} className="w-12 px-1 py-0.5 border border-red-200 rounded text-center font-mono text-red-700 focus:ring-2 focus:ring-red-400 focus:outline-none" value={item.personalLeave} onChange={(e) => updateVal(item.empId, 'personalLeave', e.target.value)} onBlur={(e) => handleTimeBlur(item.empId, 'personalLeave', e.target.value)} /></td>
                                                    <td className="px-1 py-1 bg-sky-50"><input disabled={isLocked} className="w-12 px-1 py-0.5 border border-sky-200 rounded text-center font-mono text-sky-600 focus:ring-2 focus:ring-sky-400 focus:outline-none" value={item.annualLeave} onChange={(e) => updateVal(item.empId, 'annualLeave', e.target.value)} onBlur={(e) => handleTimeBlur(item.empId, 'annualLeave', e.target.value)} /></td>
                                                    <td className="px-1 py-1 bg-red-100"><input disabled={isLocked} className="w-12 px-1 py-0.5 border border-red-300 rounded text-center font-mono text-red-800 font-bold focus:ring-2 focus:ring-red-400 focus:outline-none" value={item.absentTime || "00:00"} onChange={e=>updateVal(item.empId,'absentTime',e.target.value)} onBlur={e=>handleTimeBlur(item.empId,'absentTime',e.target.value)}/></td>
                                                    <td className="px-1 py-1 bg-amber-50"><input type="number" disabled={isLocked} className="w-14 px-1 py-0.5 border border-amber-200 rounded text-center focus:ring-2 focus:ring-amber-400 focus:outline-none" value={item.deduction} onChange={e=>updateVal(item.empId,'deduction',e.target.value)}/></td>
                                                    <td className={`px-1 py-1 sticky right-0 z-10 font-bold text-blue-700 text-right font-mono ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>${formatNumber(item.netPay)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                <div className="grid grid-cols-1 gap-3 md:hidden">{fullPayrollListFlat.map(item => (<div key={item.id} className="bg-white p-4 rounded-lg shadow active:bg-blue-50 transition border border-gray-100" onClick={() => !isLocked && setMobileEditItem(item)}><div className="flex justify-between items-center"><div><div className="font-bold text-lg">{item.name}</div><div className="text-xs text-gray-500">實發薪資</div></div><div className="text-2xl font-bold text-blue-600">${formatNumber(item.netPay)}</div></div><div className="mt-3 pt-3 border-t flex justify-between text-xs text-gray-500"><span>加項: ${formatNumber(item.totalAdditions)}</span><span>扣項: ${formatNumber(item.finalDeduction)}</span><span>工時: {item.actualWorkHours} / 應勤: {item.expectedHoursStr}</span></div>{!isLocked && <div className="text-center text-xs text-blue-400 mt-2">點擊編輯明細</div>}</div>))}</div>
                            </div>
                        )}

                        {activeTab === 'print' && (
                            <div className="print-block space-y-4 screen-preview-container">
                                <div className="bg-white p-4 rounded shadow print-hidden print-header-block">
                                    <h2 className="text-lg font-bold mb-3">📄 報表預覽 (電腦版：2欄卡片)</h2>
                                    <div className="flex space-x-3">
                                        <button onClick={handleExportPaymentList} className="flex-1 py-3 bg-emerald-600 text-white rounded-lg font-bold flex items-center justify-center hover:bg-emerald-700 transition">
                                            <Icons.Download className="w-5 h-5 mr-2"/> 匯出 Excel
                                        </button>
                                        <button onClick={()=>window.print()} className="flex-1 py-3 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-900 transition">
                                            🖨️ 列印薪資單
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="print-container-root">
                                    {chunkedPayrollList.map((chunk, pageIndex) => (
                                        <div key={pageIndex} className="print-page">
                                            {chunk.map(item => (
                                                <div key={item.id} className="payroll-slip-style">
                                                    <div className="slip-title print-title">{getTitle(currentPeriod)} 薪資單</div>
                                                    <div className="emp-info-row">
                                                        <span className="emp-name">{item.name} <span className="emp-id">({item.empId})</span></span>
                                                        <span className="emp-dept">{item.department}</span>
                                                    </div>
                                                    <div className="body-grid">
                                                        <div>
                                                            <div className="section-title">應發項目 (+)</div>
                                                            {(safeNum(item.baseSalary) > 0) && <div className="item-row"><span className="item-label">底薪</span><span className="item-value">${formatNumber(item.baseSalary)}</span></div>}
                                                            {item.payWt034 > 0 && <div className="item-row"><span className="item-label">平日加班(1.34)</span><span className="item-value">${formatNumber(item.payWt034)}</span></div>}
                                                            {item.payWt067 > 0 && <div className="item-row"><span className="item-label">平日加班(1.67)</span><span className="item-value">${formatNumber(item.payWt067)}</span></div>}
                                                            {item.payHd134 > 0 && <div className="item-row"><span className="item-label">例假加班(1.34)</span><span className="item-value">${formatNumber(item.payHd134)}</span></div>}
                                                            {item.payHd167 > 0 && <div className="item-row"><span className="item-label">例假加班(1.67)</span><span className="item-value">${formatNumber(item.payHd167)}</span></div>}
                                                            {item.payEarly > 0 && <div className="item-row"><span className="item-label">提早上班</span><span className="item-value">${formatNumber(item.payEarly)}</span></div>}
                                                            {item.payNoLunch > 0 && <div className="item-row"><span className="item-label">中午未休</span><span className="item-value">${formatNumber(item.payNoLunch)}</span></div>}
                                                            {item.payHolidayOT > 0 && <div className="item-row"><span className="item-label">休假加班</span><span className="item-value">${formatNumber(item.payHolidayOT)}</span></div>}
                                                            {item.lunchAllowance > 0 && <div className="item-row"><span className="item-label">午餐津貼</span><span className="item-value">${formatNumber(item.lunchAllowance)}</span></div>}
                                                            {item.businessBonus > 0 && <div className="item-row"><span className="item-label">業務獎金</span><span className="item-value">${formatNumber(item.businessBonus)}</span></div>}
                                                            {item.otherBonus > 0 && <div className="item-row"><span className="item-label">其它加項</span><span className="item-value">${formatNumber(item.otherBonus)}</span></div>}
                                                            <div className="subtotal-row"><span>應發合計</span><span>${formatNumber(item.grossPay)}</span></div>
                                                        </div>
                                                        <div className="body-divider"></div>
                                                        <div>
                                                            <div className="section-title">應扣項目 (-)</div>
                                                            {(safeNum(item.insuranceFee) > 0) && <div className="item-row"><span className="item-label">勞健保費</span><span className="item-value text-red-700">${formatNumber(item.insuranceFee)}</span></div>}
                                                            
                                                            {/* V37.24 FIX: 簡化假別名稱 */}
                                                            {item.dedSick > 0 && <div className="item-row"><span className="item-label">病假 (${item.sickLeave})</span><span className="item-value text-red-700">${formatNumber(item.dedSick)}</span></div>}
                                                            {item.dedPersonal > 0 && <div className="item-row"><span className="item-label">事假 (${item.personalLeave})</span><span className="item-value text-red-700">${formatNumber(item.dedPersonal)}</span></div>}
                                                            
                                                            {/* V37.24 FIX: 遲到只顯示名稱「遲到」 */}
                                                            {item.dedLate > 0 && <div className="item-row"><span className="item-label">遲到 (${item.calcLateHoursStr})</span><span className="item-value text-red-700">${formatNumber(item.dedLate)}</span></div>}
                                                            
                                                            {/* V37.24 FIX: 曠職只顯示名稱「曠職」 */}
                                                            {item.dedAbsent > 0 && <div className="item-row"><span className="item-label">曠職 (${item.absentTime})</span><span className="item-value text-red-700">${formatNumber(item.dedAbsent)}</span></div>}
                                                            
                                                            <div className="subtotal-row" style={{color:'#dc2626'}}><span>應扣合計</span><span>${formatNumber(item.finalDeduction)}</span></div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Footer 佈局 */}
                                                    <div className="footer">
                                                        <div className="footer-main">
                                                            <div className="footer-left">
                                                                <p style={{fontWeight:'bold', marginBottom:'2px'}}>感謝您本月的辛勞！</p>
                                                                <span className="footer-hours-info">實工:{item.actualWorkHours} / 應勤:{item.expectedHoursStr}H</span><br/>
                                                                {item.note && <div style={{marginTop:'2px', fontSize:'11px'}}>備註:{item.note}</div>}
                                                            </div>
                                                            <div className="footer-right">
                                                                <span className="net-pay-label">實發</span>
                                                                <span className="net-pay-value">${formatNumber(item.netPay)}</span>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* 假別顯示在最底部 */}
                                                        <div className="footer-leaves">
                                                            {(timeStrToHours(item.annualLeave) > 0) && <span style={{marginRight:'8px'}}>特休:{item.annualLeave}</span>}
                                                            {(timeStrToHours(item.bereavementLeave) > 0) && <span style={{marginRight:'8px'}}>喪假:{item.bereavementLeave}</span>}
                                                            {(timeStrToHours(item.sickLeave) > 0) && <span style={{marginRight:'8px'}}>病假:{item.sickLeave}</span>}
                                                            {(timeStrToHours(item.personalLeave) > 0) && <span style={{marginRight:'8px'}}>事假:{item.personalLeave}</span>}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* V38.2 時數預覽 Modal - 緊湊版 + 上下頁 */}
                        {hoursPreviewItem && (
                            <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-2 z-50 print-hidden" onClick={() => setHoursPreviewItem(null)}>
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl" onClick={e => e.stopPropagation()}>
                                    {/* Header */}
                                    <div className="bg-slate-800 text-white px-4 py-2 rounded-t-xl flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <span style={{fontSize:'28px', fontWeight:'900'}}>{hoursPreviewItem.name}</span>
                                            <span className="text-slate-300" style={{fontSize:'18px'}}>({hoursPreviewItem.empId})</span>
                                            <span className="bg-yellow-500 text-black px-3 py-0.5 rounded-full" style={{fontSize:'16px', fontWeight:'700'}}>{hoursPreviewItem.department}</span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button 
                                                onClick={() => {
                                                    const idx = fullPayrollListFlat.findIndex(e => e.empId === hoursPreviewItem.empId);
                                                    if (idx > 0) setHoursPreviewItem(fullPayrollListFlat[idx - 1]);
                                                }}
                                                disabled={fullPayrollListFlat.findIndex(e => e.empId === hoursPreviewItem.empId) === 0}
                                                className="bg-slate-600 hover:bg-slate-500 disabled:bg-slate-700 disabled:opacity-50 px-3 py-1 rounded-lg transition"
                                                style={{fontSize:'16px'}}
                                            >
                                                ◀ 上一位
                                            </button>
                                            <span className="text-slate-400 px-2" style={{fontSize:'16px'}}>
                                                {fullPayrollListFlat.findIndex(e => e.empId === hoursPreviewItem.empId) + 1}/{fullPayrollListFlat.length}
                                            </span>
                                            <button 
                                                onClick={() => {
                                                    const idx = fullPayrollListFlat.findIndex(e => e.empId === hoursPreviewItem.empId);
                                                    if (idx < fullPayrollListFlat.length - 1) setHoursPreviewItem(fullPayrollListFlat[idx + 1]);
                                                }}
                                                disabled={fullPayrollListFlat.findIndex(e => e.empId === hoursPreviewItem.empId) === fullPayrollListFlat.length - 1}
                                                className="bg-slate-600 hover:bg-slate-500 disabled:bg-slate-700 disabled:opacity-50 px-3 py-1 rounded-lg transition"
                                                style={{fontSize:'16px'}}
                                            >
                                                下一位 ▶
                                            </button>
                                            <button onClick={() => setHoursPreviewItem(null)} className="hover:bg-slate-700 rounded-lg p-1 ml-2">
                                                <Icons.X className="w-7 h-7"/>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="p-3">
                                        {/* 主要三欄佈局 */}
                                        <div className="grid grid-cols-3 gap-3">
                                            
                                            {/* 左欄：出勤 */}
                                            <div className="bg-blue-50 rounded-lg p-3 border border-blue-200">
                                                <div className="text-blue-800 border-b border-blue-300 pb-1 mb-2 text-center" style={{fontSize:'18px', fontWeight:'800'}}>📅 出勤時數</div>
                                                <table className="w-full">
                                                    <tbody>
                                                        <tr className="border-b border-blue-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>應勤天數</td>
                                                            <td className="text-right text-blue-700 font-mono" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.expectedWorkDays}天</td>
                                                        </tr>
                                                        <tr className="border-b border-blue-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>應勤時數</td>
                                                            <td className="text-right text-blue-700 font-mono" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.expectedHoursStr}</td>
                                                        </tr>
                                                        <tr className="border-b border-blue-100 bg-white">
                                                            <td className="text-gray-600 pl-1" style={{fontSize:'14px'}}>實際工時</td>
                                                            <td className="text-right text-green-600 font-mono pr-1" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.actualWorkHours}</td>
                                                        </tr>
                                                        {hoursPreviewItem.calcLateHoursVal > 0 && (
                                                            <tr className="bg-yellow-100">
                                                                <td className="text-yellow-800 pl-1" style={{fontSize:'14px'}}>⚠️ 短缺</td>
                                                                <td className="text-right text-yellow-700 font-mono pr-1" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.calcLateHoursStr}</td>
                                                            </tr>
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            {/* 中欄：加班 */}
                                            <div className="bg-purple-50 rounded-lg p-3 border border-purple-200">
                                                <div className="text-purple-800 border-b border-purple-300 pb-1 mb-2 text-center" style={{fontSize:'18px', fontWeight:'800'}}>⏰ 加班時數</div>
                                                <table className="w-full">
                                                    <tbody>
                                                        <tr className="border-b border-purple-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>平日 1.34</td>
                                                            <td className="text-right font-mono text-purple-800" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.wt034}</td>
                                                        </tr>
                                                        <tr className="border-b border-purple-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>平日 1.67</td>
                                                            <td className="text-right font-mono text-purple-800" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.wt067}</td>
                                                        </tr>
                                                        <tr className="border-b border-purple-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>例假 1.34</td>
                                                            <td className="text-right font-mono text-purple-800" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.hd134}</td>
                                                        </tr>
                                                        <tr className="border-b border-purple-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>例假 1.67</td>
                                                            <td className="text-right font-mono text-purple-800" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.hd167}</td>
                                                        </tr>
                                                        <tr className="border-b border-purple-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>提早上班</td>
                                                            <td className="text-right font-mono text-purple-800" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.earlyShift}</td>
                                                        </tr>
                                                        <tr className="border-b border-purple-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>中午未休</td>
                                                            <td className="text-right font-mono text-purple-800" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.noLunch}</td>
                                                        </tr>
                                                        <tr>
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>休假加班</td>
                                                            <td className="text-right font-mono text-purple-800" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.holidayOT}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            {/* 右欄：請假 */}
                                            <div className="bg-red-50 rounded-lg p-3 border border-red-200">
                                                <div className="text-red-800 border-b border-red-300 pb-1 mb-2 text-center" style={{fontSize:'18px', fontWeight:'800'}}>📋 請假/缺勤</div>
                                                <table className="w-full">
                                                    <tbody>
                                                        <tr className="border-b border-red-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>特休假</td>
                                                            <td className="text-right font-mono text-blue-600" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.annualLeave}</td>
                                                        </tr>
                                                        <tr className="border-b border-red-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>病假</td>
                                                            <td className="text-right font-mono text-orange-600" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.sickLeave}</td>
                                                        </tr>
                                                        <tr className="border-b border-red-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>事假</td>
                                                            <td className="text-right font-mono text-red-600" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.personalLeave}</td>
                                                        </tr>
                                                        <tr className="border-b border-red-100">
                                                            <td className="text-gray-600" style={{fontSize:'14px'}}>喪假</td>
                                                            <td className="text-right font-mono text-gray-700" style={{fontSize:'24px', fontWeight:'800'}}>{hoursPreviewItem.bereavementLeave}</td>
                                                        </tr>
                                                        <tr className="bg-red-200">
                                                            <td className="text-red-800 pl-1" style={{fontSize:'14px', fontWeight:'700'}}>曠職</td>
                                                            <td className="text-right font-mono text-red-700 pr-1" style={{fontSize:'24px', fontWeight:'900'}}>{hoursPreviewItem.absentTime || "00:00"}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        
                                        {/* 加項/扣項明細 */}
                                        <div className="mt-3 grid grid-cols-2 gap-3">
                                            {/* 加項明細 */}
                                            <div className="bg-green-50 rounded-lg p-2 border border-green-200">
                                                <div className="text-green-800 font-bold text-sm border-b border-green-200 pb-1 mb-1">💰 加項明細</div>
                                                <div className="grid grid-cols-2 gap-x-2 text-sm">
                                                    <span className="text-gray-600">加班費</span>
                                                    <span className="text-right font-mono text-green-700">${formatNumber(hoursPreviewItem.overtimePay || 0)}</span>
                                                    <span className="text-gray-600">業務獎金</span>
                                                    <span className="text-right font-mono text-green-700 font-bold">${formatNumber(hoursPreviewItem.businessBonus || 0)}</span>
                                                    <span className="text-gray-600">午餐津貼</span>
                                                    <span className="text-right font-mono text-green-700">${formatNumber(hoursPreviewItem.lunchAllowance || 0)}</span>
                                                    <span className="text-gray-600">其他加項</span>
                                                    <span className="text-right font-mono text-green-700">${formatNumber(hoursPreviewItem.otherBonus || 0)}</span>
                                                </div>
                                            </div>
                                            {/* 扣項明細 */}
                                            <div className="bg-red-50 rounded-lg p-2 border border-red-200">
                                                <div className="text-red-800 font-bold text-sm border-b border-red-200 pb-1 mb-1">📉 扣項明細</div>
                                                <div className="grid grid-cols-2 gap-x-2 text-sm">
                                                    <span className="text-gray-600">勞保自付</span>
                                                    <span className="text-right font-mono text-red-600">${formatNumber(hoursPreviewItem.laborFee || 0)}</span>
                                                    <span className="text-gray-600">健保自付</span>
                                                    <span className="text-right font-mono text-red-600">${formatNumber(hoursPreviewItem.healthFee || 0)}</span>
                                                    <span className="text-gray-600">請假扣款</span>
                                                    <span className="text-right font-mono text-red-600">${formatNumber((hoursPreviewItem.dedSick || 0) + (hoursPreviewItem.dedPersonal || 0))}</span>
                                                    <span className="text-gray-600">其他扣項</span>
                                                    <span className="text-right font-mono text-red-600">${formatNumber(hoursPreviewItem.otherDeduction || 0)}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* 底部：薪資摘要 */}
                                        <div className="mt-3 bg-gradient-to-r from-slate-700 to-green-700 rounded-lg p-3 flex items-center justify-between text-white">
                                            <div className="flex gap-4 items-center">
                                                <div className="text-center">
                                                    <div style={{fontSize:'12px'}} className="opacity-80">底薪</div>
                                                    <div className="font-mono" style={{fontSize:'22px', fontWeight:'800'}}>${formatNumber(hoursPreviewItem.baseSalary)}</div>
                                                </div>
                                                <div style={{fontSize:'28px', fontWeight:'300'}}>+</div>
                                                <div className="text-center">
                                                    <div style={{fontSize:'12px'}} className="opacity-80">加項</div>
                                                    <div className="font-mono text-green-300" style={{fontSize:'22px', fontWeight:'800'}}>${formatNumber(hoursPreviewItem.totalAdditions)}</div>
                                                </div>
                                                <div style={{fontSize:'28px', fontWeight:'300'}}>−</div>
                                                <div className="text-center">
                                                    <div style={{fontSize:'12px'}} className="opacity-80">扣項</div>
                                                    <div className="font-mono text-red-300" style={{fontSize:'22px', fontWeight:'800'}}>${formatNumber(hoursPreviewItem.finalDeduction)}</div>
                                                </div>
                                            </div>
                                            <div className="text-center bg-white/20 rounded-lg px-4 py-1">
                                                <div style={{fontSize:'14px'}} className="opacity-90">實發薪資</div>
                                                <div className="font-mono text-yellow-300" style={{fontSize:'36px', fontWeight:'900'}}>${formatNumber(hoursPreviewItem.netPay)}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Mobile Edit Modal */}
                        {mobileEditItem && <div className="fixed inset-0 bg-white z-50 overflow-y-auto pb-safe print-hidden"><div className="sticky top-0 bg-slate-800 text-white p-4 flex justify-between items-center shadow"><div><div className="font-bold text-lg">{mobileEditItem.name}</div><div className="text-xs opacity-75">{currentPeriod} 編輯</div></div><button onClick={() => setMobileEditItem(null)} className="px-4 py-1 bg-slate-600 rounded">完成</button></div><div className="p-4 space-y-6"><div className="space-y-3"><h3 className="font-bold text-gray-500 border-b pb-1">工時紀錄</h3><div className="grid grid-cols-2 gap-4"><label className="block text-sm">應上班天數 <input type="number" className="w-full border rounded p-2 mt-1" value={mobileEditItem.expectedWorkDays} onChange={e=>updateVal(mobileEditItem.empId, 'expectedWorkDays', e.target.value)}/></label><label className="block text-sm">應上班時數 (手動) <input type="text" className="w-full border rounded p-2 mt-1" value={mobileEditItem.expectedWorkHours} onChange={e=>updateVal(mobileEditItem.empId, 'expectedWorkHours', e.target.value)} onBlur={e=>handleTimeBlur(mobileEditItem.empId, 'expectedWorkHours', e.target.value)}/></label><label className="block text-sm">實際時數 <input type="text" className="w-full border rounded p-2 mt-1 bg-gray-50" value={mobileEditItem.actualWorkHours} onChange={e=>updateVal(mobileEditItem.empId, 'actualWorkHours', e.target.value)} onBlur={e=>handleTimeBlur(mobileEditItem.empId, 'actualWorkHours', e.target.value)}/></label><label className="block text-sm">曠職時數 <input type="text" className="w-full border rounded p-2 mt-1" value={mobileEditItem.absentTime} onChange={e=>updateVal(mobileEditItem.empId, 'absentTime', e.target.value)} onBlur={e=>handleTimeBlur(mobileEditItem.empId, 'absentTime', e.target.value)}/></label></div></div><div className="space-y-3"><h3 className="font-bold text-blue-600 border-b pb-1">加班時數</h3><div className="grid grid-cols-2 gap-4"><label className="block text-sm">平加 1.34 <input type="text" className="w-full border rounded p-2 mt-1" value={mobileEditItem.wt034} onChange={e=>updateVal(mobileEditItem.empId, 'wt034', e.target.value)} onBlur={e=>handleTimeBlur(mobileEditItem.empId, 'wt034', e.target.value)}/></label><label className="block text-sm">平加 1.67 <input type="text" className="w-full border rounded p-2 mt-1" value={mobileEditItem.wt067} onChange={e=>updateVal(mobileEditItem.empId, 'wt067', e.target.value)} onBlur={e=>handleTimeBlur(mobileEditItem.empId, 'wt067', e.target.value)}/></label><label className="block text-sm">例假 1.34 <input type="text" className="w-full border rounded p-2 mt-1" value={mobileEditItem.hd134} onChange={e=>updateVal(mobileEditItem.empId, 'hd134', e.target.value)} onBlur={e=>handleTimeBlur(mobileEditItem.empId, 'hd134', e.target.value)}/></label><label className="block text-sm">例假 1.67 <input type="text" className="w-full border rounded p-2 mt-1" value={mobileEditItem.hd167} onChange={e=>updateVal(mobileEditItem.empId, 'hd167', e.target.value)} onBlur={e=>handleTimeBlur(mobileEditItem.empId, 'hd167', e.target.value)}/></label></div></div><div className="h-20"></div></div></div>}
                        {/* Modals */}
                        {isImportModalOpen && <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden"><div className="bg-white p-6 rounded shadow-xl w-full max-w-lg"><h3 className="font-bold text-lg mb-4">匯入 Excel</h3><input type="file" ref={fileInputRef} accept=".xlsx,.csv" onChange={handleExcel} className="border p-2 w-full"/><button onClick={()=>setIsImportModalOpen(false)} className="mt-4 px-4 py-2 bg-gray-200 rounded">關閉</button></div></div>}
                        
                        {isEmpModalOpen && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden">
                                <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl">
                                    <div className="bg-slate-800 text-white px-4 py-2 rounded-t-lg flex justify-between items-center">
                                        <h3 className="font-bold text-lg">{editingEmp?.id ? '編輯員工' : '新增員工'}</h3>
                                        <button onClick={()=>setIsEmpModalOpen(false)} className="hover:bg-slate-700 rounded p-1">
                                            <Icons.X className="w-5 h-5"/>
                                        </button>
                                    </div>
                                    <form key={editingEmp?.id || 'new'} onSubmit={handleSaveEmployee} className="p-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            {/* 左欄：基本資料 */}
                                            <div className="space-y-2">
                                                <div className="text-xs font-bold text-gray-500 border-b pb-1">👤 基本資料</div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <input name="empId" defaultValue={editingEmp?.empId} placeholder="員工編號" className="border p-1.5 rounded text-sm"/>
                                                    <input name="name" defaultValue={editingEmp?.name} placeholder="姓名" className="border p-1.5 rounded text-sm"/>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <input name="department" defaultValue={editingEmp?.department} placeholder="部門" className="border p-1.5 rounded text-sm"/>
                                                    <input name="title" defaultValue={editingEmp?.title} placeholder="職位" className="border p-1.5 rounded text-sm"/>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="text-xs text-gray-400">底薪</label>
                                                        <input name="baseSalary" type="number" defaultValue={editingEmp?.baseSalary} placeholder="底薪" className="border p-1.5 rounded text-sm w-full"/>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-gray-400">業務獎金</label>
                                                        <input name="defaultBusinessBonus" type="number" defaultValue={editingEmp?.defaultBusinessBonus} placeholder="業務獎金" className="border p-1.5 rounded text-sm w-full"/>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-xs text-gray-400">上次調薪日期</label>
                                                    <input name="lastRaiseDate" type="date" defaultValue={editingEmp?.lastRaiseDate} className="border p-1.5 rounded text-sm w-full"/>
                                                </div>
                                            </div>
                                            
                                            {/* 右欄：勞健保設定 */}
                                            <div className="space-y-2">
                                                <div className="text-xs font-bold text-gray-500 border-b pb-1">🏥 勞健保設定</div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="text-xs text-gray-400">勞保自付</label>
                                                        <input name="laborFee" type="number" defaultValue={editingEmp?.laborFee} placeholder="勞保自付" className="border p-1.5 rounded text-sm w-full"/>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-gray-400">健保自付</label>
                                                        <input name="healthFee" type="number" defaultValue={editingEmp?.healthFee} placeholder="健保自付" className="border p-1.5 rounded text-sm w-full"/>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label className="text-xs text-gray-400">勞保投保額</label>
                                                        <input name="laborInsuranceBase" type="number" defaultValue={editingEmp?.laborInsuranceBase || 30300} className="border p-1.5 rounded text-sm w-full"/>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-gray-400">健保投保額</label>
                                                        <input name="healthInsuranceBase" type="number" defaultValue={editingEmp?.healthInsuranceBase || 30300} className="border p-1.5 rounded text-sm w-full"/>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-xs text-gray-400">勞退提撥率 (如 0.06)</label>
                                                    <input name="pensionRate" type="number" step="0.01" defaultValue={editingEmp?.pensionRate || 0.06} className="border p-1.5 rounded text-sm w-full"/>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="flex justify-end gap-2 mt-4 pt-3 border-t">
                                            <button type="button" onClick={()=>setIsEmpModalOpen(false)} className="px-4 py-1.5 border rounded text-gray-600 hover:bg-gray-100">取消</button>
                                            <button className="px-4 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700">儲存</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}
                        
                        {isBulkModalOpen && <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden"><div className="bg-white p-6 rounded shadow-xl w-full max-w-sm"><h3 className="font-bold text-lg mb-4">批量調薪 (限作業員)</h3><form onSubmit={handleBulkSubmit} className="space-y-3"><input type="number" value={bulkTargetSalary} onChange={e=>setBulkTargetSalary(e.target.value)} className="border p-2 w-full" placeholder="新底薪"/><div className="flex justify-end gap-2"><button type="button" onClick={()=>setIsBulkModalOpen(false)} className="px-3 py-1 border rounded">取消</button><button className="px-3 py-1 bg-orange-600 text-white rounded">執行</button></div></form></div></div>}
                        
                        {/* V38.0 備份/還原 Modal */}
                        {isBackupModalOpen && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 print-hidden">
                                <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-lg">📦 資料備份與還原</h3>
                                        <button onClick={()=>setIsBackupModalOpen(false)} className="text-gray-400 hover:text-gray-600">
                                            <Icons.X className="w-5 h-5"/>
                                        </button>
                                    </div>
                                    
                                    <div className="space-y-4">
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                            <h4 className="font-bold text-blue-800 mb-2">💾 匯出備份</h4>
                                            <p className="text-sm text-blue-600 mb-3">將所有員工資料、薪資記錄匯出為 JSON 檔案</p>
                                            <button onClick={handleExportBackup} className="w-full py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center">
                                                <Icons.Download className="w-4 h-4 mr-2"/> 下載備份檔案
                                            </button>
                                        </div>
                                        
                                        <div className="bg-orange-50 p-4 rounded-lg border border-orange-100">
                                            <h4 className="font-bold text-orange-800 mb-2">📂 匯入還原</h4>
                                            <p className="text-sm text-orange-600 mb-3">從備份檔案還原資料 (會覆蓋現有資料)</p>
                                            <input 
                                                type="file" 
                                                ref={backupFileInputRef}
                                                accept=".json" 
                                                onChange={handleImportBackup}
                                                className="hidden"
                                                id="backup-file-input"
                                            />
                                            <label htmlFor="backup-file-input" className="w-full py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition flex items-center justify-center cursor-pointer">
                                                <Icons.Upload className="w-4 h-4 mr-2"/> 選擇備份檔案
                                            </label>
                                        </div>
                                        
                                        <div className="bg-gray-50 p-3 rounded text-xs text-gray-500">
                                            <p>📊 目前資料統計：</p>
                                            <p>• 員工數量：{employees.length} 人</p>
                                            <p>• 薪資記錄：{payrollData.length} 筆</p>
                                            <p>• 結案月份：{Object.keys(monthlyStatus).filter(k => monthlyStatus[k] === 'locked').length} 個</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                    <MobileNav activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ToastProvider><PayrollApp /></ToastProvider>);
    </script>
</body>
</html>